<!DOCTYPE html>
<html lang="ml">
<head>
  <meta charset="UTF-8">
  <title>KSEB Prosumer Bill Calculator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Malayalam font -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Malayalam&display=swap" rel="stylesheet">
  <!-- PDF download support -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  

<style>
/* ===============================
   KSEB Prosumer Bill Calculator
   Consolidated & Annotated CSS
   =============================== */

/* ===== 1. Base Layout & Typography ===== */
body {
  font-family: 'Noto Sans Malayalam', Arial, sans-serif;
  margin: 1rem;
  background: #f7f7f7;
}

h1 {
  color: #1e88e5;
  font-size: 1.5rem;
}

hr {
  margin: 0.1rem 0;
}

h3 {
  margin-top: 0.1rem; /* smaller top margin */
  margin-bottom: 0.1rem;
}

@media (min-width: 600px) {
  h1 { font-size: 2rem; }
}

/* ===== 2. Form Elements ===== */
select, input[type="number"], button {
  font-size: 16px;
  padding: 8px;
  width: 100%;
  max-width: 400px;
  box-sizing: border-box;
  margin-bottom: 10px;
}

input, select, textarea {
  line-height: 1.4;
  padding: 8px; /* Prevents mobile browser zoom on focus */
}

button {
  cursor: pointer;
}

@media (min-width: 768px) {
  select, input[type="number"], button {
    max-width: 500px;
  }
}

@media (max-width: 767px) {
  select, input[type="number"], button {
    font-size: 20px; /* Larger for touch devices */
  }
}


@media print {
  .no-print {
    display: none !important;
  }
}

input, select, button, label {
  max-width: 100% !important;
  box-sizing: border-box;
}

/* ===== 3. Results Box ===== */
.result {
  background: #e3f2fd;
  padding: 1rem;
  margin-top: 1rem;
  border-left: 5px solid #1e88e5;
 word-wrap: break-word;
}

.result h3 {
  margin-bottom: 1rem;
  margin-top: 1rem;
}

/* ===== 4. Timestamp & Update Info ===== */
.timestamp {
  font-size: 0.9rem;
  color: #555;
  margin-bottom: 1rem;
}

/* ===== 5. Debug Panel ===== */
.debug {
  background: #fff8dc;
  color: #333;
  font-family: monospace;
  white-space: pre-wrap;
  border: 1px dashed #aaa;
  padding: 1rem;
  margin-top: 1rem;
}

.hidden { display: none; }

/* ===== 6. PDF Download Button ===== */
#downloadFullPDF {
  background: #4CAF50;
  color: white;
  border: none;
  padding: 0.75rem;
  font-size: 1rem;
  width: 100%;
  margin-top: 2rem;
}

/* ===== 7. PDF & Print Adjustments ===== */
#pdfContent {
  transform: scale(0.94);
  transform-origin: top left;
  width: 100%;
}

.result, .input-section {
  zoom: 0.85; /* Scales content visually */
  transform-origin: top left;
}

/* Force page break */
.pdf-page-break {
  page-break-before: always !important; /* start a new page before this element */
  break-before: page !important;        /* modern browsers */
  display: block !important;

  /* Ensure no leftover spacing */
  margin: 0;
  padding: 0;
  border: none;

  /* Optional: make it invisible but still functional */
  height: 50px; /* small positive height */
  background: none;
}

/* Avoid breaking inside these important sections */
.avoid-page-break {
  page-break-inside: avoid !important;
  break-inside: avoid !important;
  -webkit-column-break-inside: avoid !important;
  -moz-column-break-inside: avoid !important;
  display: block !important;
  margin-bottom: 0 !important; /* reduce gap */
  padding-bottom: 1 !important;
  overflow: visible !important;
}


/* Print-only adjustments */
@media print {
  body, html, #pdfContent { width: 90% !important; }
  #billForm, #downloadFullPDF, .timestamp, #debugPanel {
    display: none;
  }
  .result { display: block !important; }
}

/* ===== 8. Global Width & Overflow Fix ===== */
body, html, #pdfContent {
  width: 100% !important;
  max-width: none !important;
  overflow-x: visible !important;
}
</style>
</head>



<body>


    <!-- ===== Main PDF Content ===== -->
  
    <!-- Title -->
    <h1>KSEB Prosumer Bill Calculator / ‡¥ï‡µÜ.‡¥é‡¥∏‡µç.‡¥á.‡¥¨‡¥ø. ‡¥™‡µç‡¥∞‡µã‡¥∏‡µç‡¥Ø‡µÇ‡¥Æ‡µº ‡¥¨‡¥ø‡µΩ ‡¥ï‡¥æ‡µΩ‡¥ï‡µç‡¥ï‡µÅ‡¥≤‡µá‡¥±‡µç‡¥±‡µº</h1>

    <!-- Top Info Bar: Timestamp & Last Update -->
    <div style="display: flex; justify-content: space-between; font-size: 0.9rem; color: #555; margin-bottom: 1rem;">
      <div id="timestamp"></div>
      <div id="lastUpdatedDisplay"></div>
    </div>

    

    <!-- ===== Bill Input Form ===== -->
    <form id="billForm">

      <!-- Connection Type -->
      <label for="connectionType">Connection Type / ‡¥ï‡¥£‡¥ï‡µç‡¥∑‡µª ‡¥§‡¥∞‡¥Ç:</label>
      <select id="connectionType" title="Select your connection type">
        <option value="LT1">LT-1 Domestic / ‡¥°‡µä‡¥Æ‡¥∏‡µç‡¥±‡µç‡¥±‡¥ø‡¥ï‡µç</option>
      </select>

      <!-- Phase Type -->
      <label for="phaseType">Phase Type / ‡¥´‡µá‡¥∏‡µç ‡¥§‡¥∞‡¥Ç:</label>
      <select id="phaseType" title="Select your phase type">
        <option value="single">Single Phase / ‡¥∏‡¥ø‡¥Ç‡¥ó‡¥ø‡µæ ‡¥´‡µá‡¥∏‡µç</option>
        <option value="three">Three Phase / ‡¥§‡µç‡¥∞‡¥ø‡¥´‡µá‡¥∏‡µç</option>
      </select>

      <!-- Previous Bank Balance -->
      <label for="Bank">Previous Bank Balance Units:</label>
      <input type="number" id="Bank" value="0" placeholder="e.g. 10">

      <!-- TOD Availability -->
      <label for="TODAvailability">Is TOD Bill Available? / ‡¥ü‡¥ø‡¥í‡¥°‡¥ø ‡¥¨‡¥ø‡µΩ ‡¥≤‡¥≠‡µç‡¥Ø‡¥Æ‡¥æ‡¥£‡µã?</label>
      <select id="TODAvailability" title="Select yes if TOD bill is available">
        <option value="No">No / ‡¥á‡¥≤‡µç‡¥≤</option>
        <option value="Yes">Yes / ‡¥â‡¥£‡µç‡¥ü‡µç</option>
      </select>

      <!-- Import Units (hidden when TOD enabled) -->
      <div id="importField">
        <label>Units Imported from Grid [I] / ‡¥ó‡µç‡¥∞‡¥ø‡¥°‡¥ø‡µΩ ‡¥®‡¥ø‡¥®‡µç‡¥®‡µÅ‡¥≥‡µç‡¥≥ ‡¥á‡¥Ç‡¥™‡µã‡µº‡¥ü‡µç‡¥ü‡µç:</label>
        <input type="number" id="importUnits" required placeholder="Units imported from grid e.g. 100">
      </div>

      <!-- Export Units -->
      <label>Units Exported to Grid [E] / ‡¥ó‡µç‡¥∞‡¥ø‡¥°‡¥ø‡¥≤‡µá‡¥ï‡µç‡¥ï‡µç ‡¥Ö‡¥Ø‡¥ö‡µç‡¥ö ‡¥Ø‡µÇ‡¥£‡¥ø‡¥±‡µç‡¥±‡µÅ‡¥ï‡µæ:</label>
      <input type="number" id="exportUnits" required placeholder="Units exported to grid e.g. 100">

      <!-- Solar Generation -->
      <label>Total Solar Energy Generation [GM] / ‡¥Æ‡µä‡¥§‡µç‡¥§‡¥Ç ‡¥∏‡µã‡¥≥‡¥æ‡µº ‡¥ä‡µº‡¥ú ‡¥â‡µΩ‡¥™‡¥æ‡¥¶‡¥®‡¥Ç:</label>
      <input type="number" id="Solar" value="0" placeholder="Units of solar generated e.g. 100">

      <!-- TOD Fields (visible only if TOD enabled) -->
      <div id="todFields" class="hidden">
        <label>Normal (day) Units (NL) / ‡¥¶‡¥ø‡¥® ‡¥∏‡¥Æ‡¥Ø ‡¥â‡¥™‡¥≠‡µã‡¥ó‡¥Ç:</label>
        <input type="number" id="todDay" placeholder="Units imported during day time (NL) e.g. 100">

        <label>Off-Peak Units (OP) / ‡¥ì‡¥´‡µç-‡¥™‡µÄ‡¥ï‡µç‡¥ï‡µç ‡¥â‡¥™‡¥≠‡µã‡¥ó‡¥Ç:</label>
        <input type="number" id="todOffpeak" placeholder="Units imported during off-peak time (OP) e.g. 100">

        <label>Peak Units (PK) / ‡¥™‡µÄ‡¥ï‡µç‡¥ï‡µç ‡¥ü‡µà‡¥Ç ‡¥â‡¥™‡¥≠‡µã‡¥ó‡¥Ç:</label>
        <input type="number" id="todPeak" placeholder="Units imported during peak time (PK) e.g. 100">
      </div>

      <!-- Submit Button -->
      <button type="submit" class="no-print" style="background-color: #007BFF; color: white; border: none; padding: 8px 16px; border-radius: 4px;">
        Calculate / ‡¥ï‡¥æ‡µΩ‡¥ï‡µç‡¥ï‡µÅ‡¥≤‡µá‡¥±‡µç‡¥±‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥ï
      </button>

      <!-- Hidden field for last update -->
      <input type="hidden" id="lastUpdated" value="09 Aug 2025">

    </form>
    <!-- ===== End of Bill Input Form ===== -->

    <!-- Calculation Result -->
    <div class="result" id="result" style="display: none;"></div>

    <!-- Debug Panel -->
    <div id="debugPanel" class="debug hidden"></div>

    <!-- PDF Download Button -->
    <button id="downloadFullPDF" class="no-print">Download Full Page as PDF</button>
    
    <!-- Page Break for PDF -->
    
  <!-- ===== End of Main PDF Content ===== -->

  <!-- ===== Custom Alert Box ===== -->
  <div id="customAlert"
       style="display:none; position:fixed; top:30%; left:50%; transform:translate(-50%,-50%);
              background:#fff; border:2px solid red; padding:20px; z-index:1000; box-shadow:0 0 10px #000; color:red;">
    <h3 style="margin-top:0;">Alert!</h3>
    <div id="customAlertMessage"></div>
    <button onclick="document.getElementById('customAlert').style.display='none'">Close</button>
  

    <script>

/* ======================================================
   KSEB Prosumer Bill Calculator - JavaScript
   Consolidated & Annotated in One Block
   ====================================================== */

document.addEventListener('DOMContentLoaded', function () {

  /* ===== 1. Initialization: Set Date, Time & Last Update ===== */
  const now = new Date();
  document.getElementById('timestamp').textContent =
    `Date: ${now.toLocaleDateString()} | Time: ${now.toLocaleTimeString()}`;

  const lastUpdatedValue = document.getElementById('lastUpdated').value;
  document.getElementById('lastUpdatedDisplay').textContent =
    `Software Last Updated: ${lastUpdatedValue}`;

  /* ===== 2. TOD Availability Toggle ===== */
  const todDropdown = document.getElementById('TODAvailability');
  const todSection = document.getElementById('todFields');
  const importField = document.getElementById('importField');
  const importUnitsInput = document.getElementById('importUnits');

  function handleTODToggle() {
    if (todDropdown.value === 'Yes') {
      todSection.classList.remove('hidden');
      importField.classList.add('hidden');
      importUnitsInput.removeAttribute('required');
    } else {
      todSection.classList.add('hidden');
      importField.classList.remove('hidden');
      importUnitsInput.setAttribute('required', '');
    }
  }

  todDropdown.addEventListener('change', handleTODToggle);
  handleTODToggle(); // Run on load

  /* ===== 3. Custom Alert Utility ===== */
  function showCustomAlert(message) {
    document.getElementById("customAlertMessage").innerHTML = message;
    document.getElementById("customAlert").style.display = "block";
  }

  /* ===== 4. Custom Yes/No Prompt Utility ===== */
  function showYesNoPrompt(message) {
    return new Promise((resolve) => {
      const modal = document.createElement("div");
      modal.id = "customPrompt";
      Object.assign(modal.style, {
        position: "fixed", top: "0", left: "0", width: "100%", height: "100%",
        backgroundColor: "rgba(0,0,0,0.5)", display: "flex",
        justifyContent: "center", alignItems: "center", zIndex: "9999"
      });

      modal.innerHTML = `
        <div style="background:white; padding:20px; border-radius:8px; max-width:500px; text-align:center">
          <div style="margin-bottom:10px;">${message}</div>
          <button id="yesBtn" style="margin-right:20px; padding:6px 14px;">Yes</button>
          <button id="noBtn" style="padding:6px 14px;">No</button>
        </div>
      `;

      document.body.appendChild(modal);
      document.getElementById("yesBtn").onclick = () => { modal.remove(); resolve(true); };
      document.getElementById("noBtn").onclick = () => { modal.remove(); resolve(false); };
    });
  }

  /* ===== 5. PDF Download Handler ===== */
document.getElementById('downloadFullPDF').addEventListener('click', () => {
  // Hide no-print elements
  document.querySelectorAll('.no-print').forEach(el => el.style.display = 'none');

  const element = document.getElementById('pdfContent');
  const opt = {
    margin: 0.3,
    filename: `KSEB_Bill_${new Date().toISOString().split('T')[0]}.pdf`,
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: {
      scale: 3, scrollY: 0, useCORS: true,
      windowWidth: element.scrollWidth,
      windowHeight: element.scrollHeight
    },
    jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' },
    pagebreak: { 
  mode: ['css', 'legacy'], 
  before: '.pdf-page-break',   // Force new page before this element
  avoid: '.avoid-page-break'   // Keep these elements from splitting
  }
  };

  html2pdf().set(opt).from(element).save().then(() => {
    // Restore no-print elements after PDF is generated
    document.querySelectorAll('.no-print').forEach(el => el.style.display = '');
  });
});


    /* ===== 6. CSV Loading & Parsing Functions ===== */
  let slabs = [], chargesTable = [], todRates = {};
  let fixedChargeTable = [], meterChargeTable = [];
  let todBaseRate = 0, totalImport = 0;
  let debugLog = []; let userChoice = "";

  function loadCSV(file, parser) {
    return fetch(file)
      .then(res => res.ok ? res.text() : Promise.reject(`Failed to load ${file}`))
      .then(text => { parser(text); debugLog.push(`[LOADED] ${file}`); })
      .catch(err => { console.error(`[CSV ERROR] ${file}:`, err); debugLog.push(`[ERROR] ${err}`); });
  }

  function parseSlabs(text) {
    const lines = text.trim().split('\n').slice(1);
    slabs = lines.map(line => {
      const [range, rate] = line.split(',');
      const upper = parseInt(range.split('-')[1] || range.match(/\d+/g)?.[0]) || 0;
      return { limit: upper, rate: parseFloat(rate) };
    });
  }

  function parseTODRates(text) {
    const lines = text.trim().split('\n').slice(1);
    todRates = {};
    lines.forEach(line => {
      const [label, rate] = line.split(',');
      todRates[label.trim().toLowerCase()] = parseFloat(rate);
    });
  }

  function parseTODTariff(text) {
    const lines = text.trim().split('\n').slice(1);
    for (let line of lines) {
      const [range, base] = line.split(',');
      const upper = /above/i.test(range) ? Infinity : parseInt(range.match(/\d+/g)?.[0]) || 0;
      if (totalImport <= upper) { todBaseRate = parseFloat(base); break; }
    }
  }

  function parseCharges(text) {
    const lines = text.trim().split('\n').slice(1);
    chargesTable = lines.map(line => {
      const [label, duty, surcharge] = line.split(',');
      return { label: label.trim(), duty: parseFloat(duty), surcharge: parseFloat(surcharge) };
    });
  }

  function parseFixedCharges(text) {
    const lines = text.trim().split('\n').slice(1);
    fixedChargeTable = lines.map(line => {
      const [slab, single, three] = line.split(',');
      let min = 0, max = Infinity;
      if (slab.includes('-')) { [min, max] = slab.split('-').map(Number); }
      else if (/above/i.test(slab)) { min = parseInt(slab.match(/\d+/)?.[0]) || 0; }
      return { min, max, label: slab.trim(), single: parseFloat(single), three: parseFloat(three) };
    });
  }

  function getFixedChargeString(importUnits, ownSolarDay) {
    const total = importUnits + ownSolarDay;
    return `I:${importUnits} + OC:${ownSolarDay} = ${total}`;
    }

  function parseMeterCharges(text) {
    const lines = text.trim().split('\n').slice(1);
    meterChargeTable = lines.map(line => {
      const [type, single, three] = line.split(',');
      return { label: type.trim(), single: parseFloat(single), three: parseFloat(three) };
    });
  }

  /* ===== 7. Bill Utility Functions ===== */
  function getFixedCharge(phaseType, totalUnits) {
    for (let row of fixedChargeTable) {
      if (totalUnits > row.min && totalUnits <= row.max) {
        return { value: phaseType === 'three' ? row.three : row.single, label: row.label };
      }
    }
    return { value: 0, label: 'Not found' };
  }

  function getMeterRent(connectionType, phaseType) {
    for (let row of meterChargeTable) {
      if (row.label === connectionType) {
        return { value: phaseType === 'three' ? row.three : row.single, label: `${row.label}-${phaseType}` };
      }
    }
    return { value: 0, label: 'Not found' };
  }

  function getOtherCharges(connectionType) {
    for (let row of chargesTable) {
      if (row.label === connectionType) {
        return { duty: row.duty, surcharge: row.surcharge };
      }
    }
    return { duty: 0, surcharge: 0 };
  }

  function getBillingTypeProsumer(importUnits, exportUnits, Solar, Bank) {
    const netUnits = importUnits - exportUnits - Bank;
    return { billtype: netUnits < 250 ? "telescopic" : "non-telescopic" };
  }

  function getBillingTypeConsumer(importUnits, exportUnits, Solar) {
    const totalUnits = importUnits + (Solar - exportUnits);
    return { billtype: totalUnits >= 250 ? "non-telescopic" : "telescopic" };
  }

  /* ===== 8. Energy Charge Calculations ===== */
  function calculateDomesticCharge(units) {
    let total = 0, prevLimit = 0;
    for (let slab of slabs) {
      if (units <= 0) break;
      const slabUnits = Math.min(units, slab.limit - prevLimit);
      total += slabUnits * slab.rate;
      units -= slabUnits;
      prevLimit = slab.limit;
    }
    return total;
  }

  function calculateDomesticChargeString(units) {
    let prevLimit = 0, parts = [];
    for (let slab of slabs) {
      if (units <= 0) break;
      const slabUnits = Math.min(units, slab.limit - prevLimit);
      const charge = slabUnits * slab.rate;
      parts.push(`${slabUnits} units * ‚Çπ${slab.rate.toFixed(2)} = ‚Çπ${charge.toFixed(2)}`);
      units -= slabUnits;
      prevLimit = slab.limit;
    }
    return parts.map((line, i) => i < parts.length - 1 ? `${line} +` : line).join('<br>') || '0 units billed';
  }

  function calculateTODCharge(day, peak, offpeak) {
    return todBaseRate * ((day * todRates.nl) + (peak * todRates.pk) + (offpeak * todRates.op));
  }

  function getTODCalculationString(day, peak, offpeak) {
    let parts = [];
    if (day) parts.push(`NL: ${day} √ó ‚Çπ${todBaseRate} √ó ${todRates.nl} = ‚Çπ${(day * todBaseRate * todRates.nl).toFixed(2)}`);
    if (offpeak) parts.push(`OP: ${offpeak} √ó ‚Çπ${todBaseRate} √ó ${todRates.op} = ‚Çπ${(offpeak * todBaseRate * todRates.op).toFixed(2)}`);
    if (peak) parts.push(`PK: ${peak} √ó ‚Çπ${todBaseRate} √ó ${todRates.pk} = ‚Çπ${(peak * todBaseRate * todRates.pk).toFixed(2)}`);
    for (let i = 0; i < parts.length - 1; i++) parts[i] += ' +';
    return parts.join('<br>') || '0 units billed';
  }
  

  async function setupBilling(importUnits) { 

    await Promise.all([
     loadCSV('fixed_charge.csv', parseFixedCharges),
    loadCSV('meter_charges.csv', parseMeterCharges),
    loadCSV('other_charges.csv', parseCharges),
    loadCSV('tariff_tod_base.csv', parseTODTariff),
    loadCSV('tariff_tod.csv', parseTODRates),
    loadCSV('tariff_domestic_telescopic.csv', parseSlabs)]);

  if (importUnits >= 250) {
    document.getElementById('todFields').classList.remove('hidden');
    
  } else {
    document.getElementById('todFields').classList.add('hidden');    
  }
}


  // ============================================
// Form Submit Event: Main Calculation Handler
// ============================================
document.getElementById('billForm').addEventListener('submit', async function (e) {
  e.preventDefault();

  // ---------------------------
  // 1. Retrieve and Parse Inputs
  // ---------------------------
  const connectionType   = document.getElementById('connectionType').value;
  const phaseType        = document.getElementById('phaseType').value;
  const exportUnits      = parseFloat(document.getElementById('exportUnits').value) || 0;
  const importUnitsInput = parseFloat(document.getElementById('importUnits').value) || 0;
  const Solar            = parseFloat(document.getElementById('Solar').value) || 0;
  const Bank             = parseFloat(document.getElementById('Bank').value) || 0;
  const TODAvailability  = document.getElementById('TODAvailability').value.trim().toLowerCase();

  // TOD-specific inputs
  const todDay     = parseFloat(document.getElementById('todDay').value) || 0;
  const todOffpeak = parseFloat(document.getElementById('todOffpeak').value) || 0;
  const todPeak    = parseFloat(document.getElementById('todPeak').value) || 0;

  // ---------------------------
  // 2. Determine Import Units
  // ---------------------------
  let importUnits;
  if (TODAvailability === "yes") {
    importUnits = todDay + todOffpeak + todPeak;
  } else {
    importUnits = importUnitsInput;
  }

  if (isNaN(importUnits)) {
    alert("Please enter a valid import unit value.");
    return;
  }

  // ---------------------------
  // 3. Load Tariff Data (Prosumer Mode)
  // ---------------------------
  await setupBilling(importUnits);

  // ---------------------------
  // 4. Core Prosumer Calculations
  // ---------------------------
  const ownSolarDay  = Solar - exportUnits;                        // Self-used solar
  const totalUnits   = importUnits + ownSolarDay;                  // I + OC
  const consumerImport = totalUnits;                               // Consumer total usage
  const netImpUnits  = Math.max(0, importUnits - exportUnits);     // N = I - E
  const netUnits     = Math.max(0, importUnits - (Bank + exportUnits)); // N - B
  const newBank      = Math.max(0, Bank + exportUnits - importUnits);   // UB

  // Billing type for prosumer
  const billmethPros = getBillingTypeProsumer(importUnits, exportUnits, Solar, Bank).billtype;

  // Fixed & Meter charges
  const meterInfo      = getMeterRent(connectionType, phaseType);
  const fixedInfo      = getFixedCharge(phaseType, totalUnits);
  const fixedChargeStr = getFixedChargeString(importUnits, ownSolarDay);
  const { value: meterCharge } = meterInfo;
  const { value: fixedCharge, label: fixedLabel } = fixedInfo;

  // Other charges (duty, surcharge)
  const { duty, surcharge } = getOtherCharges(connectionType);

  // ---------------------------
  // 5. Energy Charge Calculation (Prosumer)
  // ---------------------------
  let energyCharge = 0, EChargeString = "";
  let adjDay = 0, adjOffpeak = 0, adjPeak = 0;
  let dayTotal = 0;

  if (netUnits >= 250) {
    // Non-telescopic (TOD) billing
    const energyResult = getEnergy(todDay, todOffpeak, todPeak, importUnits, exportUnits, Bank);
    energyCharge = energyResult.energyCharge;
    EChargeString = energyResult.EChargeString;
    adjDay = energyResult.adjDay;
    adjOffpeak = energyResult.adjOffpeak;
    adjPeak = energyResult.adjPeak;
  } else {
    // Telescopic billing
    energyCharge = calculateDomesticCharge(netUnits);
    EChargeString = calculateDomesticChargeString(netUnits);
  }

  // Duty & Surcharge
  const dutyAmount      = energyCharge * duty / 100;
  const surchargeAmount = surcharge * netUnits;

  // Total Prosumer Bill
  const total = energyCharge + fixedCharge + meterCharge + dutyAmount + surchargeAmount;

  // ---------------------------
  // 6. Load Tariff Data (Consumer Mode)
  // ---------------------------
  await setupBilling(consumerImport);

  // ---------------------------
  // 7. Consumer Mode Pre-checks
  // ---------------------------
  let consumerEnergy = 0, consumerFixed = 0, consumerMeter = 0, consumerEString = "";

  const consumerMeterInfo = getMeterRent(connectionType, phaseType);
  const consumerFixedInfo = getFixedCharge(phaseType, consumerImport);
  consumerMeter = consumerMeterInfo.value;
  consumerFixed = consumerFixedInfo.value;

  // Prompt only if conditions require
  if (userChoice === "" && TODAvailability === "yes" && consumerImport >= 250) {
    dayTotal = todDay + ownSolarDay;
  }

  if (TODAvailability === "no" && consumerImport >= 250 && userChoice === "") {
    const message = `üìå Do you want to skip estimating bill as a Consumer?<br>
    ‡¥®‡¥ø‡¥ô‡µç‡¥ô‡µæ ‡¥â‡¥™‡¥≠‡µã‡¥ï‡µç‡¥§‡µÉ ‡¥¨‡¥ø‡µΩ ‡¥ï‡¥£‡¥ï‡µç‡¥ï‡¥æ‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥®‡¥§‡µç ‡¥í‡¥¥‡¥ø‡¥µ‡¥æ‡¥ï‡µç‡¥ï‡¥£‡µã?`;
    const proceed = await showYesNoPrompt(message);
    userChoice = proceed ? "skipped" : "need";
  }

  // ---------------------------
  // 8. Consumer Mode Adjustments
  // ---------------------------
  if (userChoice === "need" && TODAvailability === "no" && consumerImport >= 250) {

    if (todDay === 0 && todPeak === 0 && todOffpeak === 0) {
      showCustomAlert(`
        <br>‡¥â‡¥™‡¥≠‡µã‡¥ï‡µç‡¥§‡¥æ‡¥µ‡¥æ‡¥Ø‡¥ø ‡¥ï‡¥£‡¥ï‡µç‡¥ï‡¥æ‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥®‡¥§‡¥ø‡¥®‡µç ‡¥Æ‡µä‡¥§‡µç‡¥§‡¥Ç ‡¥Ø‡µÇ‡¥£‡¥ø‡¥±‡µç‡¥±‡µÅ‡¥ï‡µæ (I + OC) [${consumerImport} ‡¥Ø‡µÇ‡¥£‡¥ø‡¥±‡µç‡¥±‡µÅ‡¥ï‡µæ]
        ‡¥ü‡¥ø‡¥Ø‡µã‡¥ü‡¥ø (TOD) ‡¥∞‡µÄ‡¥§‡¥ø‡¥Ø‡¥ø‡µΩ ‡¥®‡µΩ‡¥ï‡¥£‡¥Ç. ‡¥∏‡µç‡¥µ‡¥Ø‡¥Ç ‡¥â‡¥™‡¥Ø‡µã‡¥ó‡¥ø‡¥ö‡µç‡¥ö ‡¥∏‡µã‡¥≥‡¥æ‡µº: <b>${ownSolarDay} ‡¥Ø‡µÇ‡¥£‡¥ø‡¥±‡µç‡¥±‡µÅ‡¥ï‡µæ</b>.
      `);
      return;
    }

    const sumImport = todDay + todPeak + todOffpeak;

    // Validation: Daytime TOD units >= own solar
    if (todDay < ownSolarDay) {
      alert(`As a Consumer, Daytime TOD units (NL) must be ‚â• Own Solar Use (GM - E) = ${ownSolarDay} units.`);
      return;
    }

    // Validation: Total TOD matches total usage
    if (sumImport !== totalUnits) {
      alert(`Mismatch: Total TOD units (${sumImport}) ‚â† Total import units (${totalUnits}).`);
      return;
    }

    dayTotal = todDay;

  } else if (userChoice === "need" && TODAvailability === "yes" && consumerImport >= 250) {
    dayTotal = todDay + ownSolarDay;
  }

  // ---------------------------
  // 9. Consumer Energy Calculation
  // ---------------------------
  const billmethCons = getBillingTypeConsumer(importUnits, exportUnits, Solar, Bank).billtype;

  if (billmethCons === "telescopic") {
    consumerEnergy  = calculateDomesticCharge(consumerImport);
    consumerEString = calculateDomesticChargeString(consumerImport);
  }

  if (billmethCons === "non-telescopic") {
    consumerEnergy  = calculateTODCharge(dayTotal, todPeak, todOffpeak);
    consumerEString = getTODCalculationString(dayTotal, todPeak, todOffpeak);
  }

  // Duty & Surcharge
  const consumerdutyAmount      = consumerEnergy * duty / 100;
  const consumersurchargeAmount = surcharge * consumerImport;

  // Total Consumer Bill
  const consumerTotal = consumerEnergy + consumerFixed + consumerMeter + consumerdutyAmount + consumersurchargeAmount;

  // =============================
// 11. Render Calculation Result
// =============================
const resultDiv = document.getElementById('result');
resultDiv.style.display = 'block';

// Build HTML output
resultDiv.innerHTML = `
<div id="pdfContent">

     <!-- Title -->
    <h3>KSEB Prosumer Bill Calculator </h3>
    
    <!-- Top Info Bar: Timestamp & Last Update -->
    Date: ${now.toLocaleDateString()} | Time: ${now.toLocaleTimeString()} <br>
    Software Last Updated: ${lastUpdatedValue}
    <br><br>
    <!-- ===== Input Summary ===== -->
    <h3>Input Values</h3>
    Connection Type: <strong>${connectionType}</strong>, 
    Phase Type: <strong>${phaseType}</strong><br><br>

    Is TOD bill available? 
    <strong>${TODAvailability.charAt(0).toUpperCase() + TODAvailability.slice(1)}</strong><br>

    ${
      (TODAvailability === "yes" || consumerImport >= 250 )
        ? `
          ${TODAvailability === "yes" 
            ? `TOD bill reading`
            : `User-entered TOD values for estimating consumer bill`}
          <br><br>

          ${
            billmethPros === "telescopic" && TODAvailability === "no"
              ? `
                <!-- Table: Prosumer NA vs Consumer TOD values -->
                
                  <table style="border-collapse: collapse; margin-bottom: 10px; width: auto; font-family: monospace; font-size: 16px;">
                    <thead>
                      <tr>
                        <th style="text-align: left; padding-right: 13ch;">Time Slot</th>
                        <th style="text-align: left; padding-right: 6ch;">As Prosumer</th>
                        <th style="text-align: left;">As Consumer</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr><td>Normal/Day Time Units</td><td>NA</td><td>${userChoice === "skipped" ? 'NA' : `${todDay} (NL + OC)`}</td></tr>
                      <tr><td>Off Peak Units (OP)</td><td>NA</td><td>${userChoice === "skipped" ? 'NA' : `${todOffpeak}`}</td></tr>
                      <tr><td>Peak Units (PK)</td><td>NA</td><td>${userChoice === "skipped" ? 'NA' : `${todPeak}`}</td></tr>
                    </tbody>
                  </table>
                
              `
              : `
                <!-- Table: TOD values only -->
               
                  <table style="border-collapse: collapse; margin-bottom: 10px; width: auto; font-family: monospace; font-size: 16px;">
                    <thead>
                      <tr>
                        <th style="text-align: left; padding-right: 18ch;">Time Slot</th>
                        <th style="text-align: left;">Units</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr><td>Normal/Day Time Units [NL]</td><td>${todDay}</td></tr>
                      <tr><td>Off Peak Units (OP)</td><td>${todOffpeak}</td></tr>
                      <tr><td>Peak Units (PK)</td><td>${todPeak}</td></tr>
                    </tbody>
                  </table>
               
              `
          }
        `
        : ``
    }
    <br>
    Units Imported (I): <strong>${importUnits}</strong><br>
    Units Exported (E): <strong>${exportUnits}</strong><br>
    
    <br>
    Total Solar Energy Generated (GM): 
      <strong>${isNaN(Solar) ? "NA" : Solar} units</strong><br>
    Own solar consumption during Day [OC]: 
      <strong>${ownSolarDay} units</strong><br><br>
    Net units Imported [N] (N = I - E): 
      <strong>${netImpUnits} units</strong><br>
    Previous banked balance [B]: 
      <strong>${Bank} units</strong>        
    
  <!-- ===== Prosumer Bill ===== -->
  <div class="pdf-page-break"> </div>
     <h3>Prosumer Bill</h3>
     <br>
    Billing Type: <strong>${connectionType}</strong>, 
    ${importUnits >= 250 ? 'TOD' : 'Non-TOD'}, 
    <strong>${billmethPros}</strong><br>

    Own solar consumption during Day [OC]: 
      <strong>${ownSolarDay} units</strong><br>

    Units Billed (N-B): <strong>${netUnits}</strong> 
      <span style="font-size: smaller; color: gray;">
        (${netImpUnits} - ${Bank} = ${netUnits})
      </span><br>

    ${billmethPros === "non-telescopic" 
      ? `Adjusted TOD Units: NL: <strong>${adjDay}</strong>, OP: <strong>${adjOffpeak}</strong>, PK: <strong>${adjPeak}</strong><br>` 
      : ``}

    <br>
    <div class="avoid-page-break">
    Energy Charge: <strong>‚Çπ ${energyCharge.toFixed(2)}</strong><br>
    <span style="font-size: smaller; color: gray;">${EChargeString}</span><br><br>
    </div>

    <div class="avoid-page-break">
    Fixed Charge: <strong>‚Çπ ${fixedCharge.toFixed(2)}</strong> 
      <span style="font-size: smaller;color: gray;">
        (${fixedChargeStr}, ${fixedLabel} slab)
      </span><br>
      
    Duty (${duty}% of Energy): <strong>‚Çπ ${dutyAmount.toFixed(2)}</strong> 
      <span style="font-size: smaller;color: gray;">
        (${energyCharge.toFixed(2)} √ó ${duty}% = ${dutyAmount.toFixed(2)})
      </span><br>

    Fuel Surcharge (${surcharge}/unit): <strong>‚Çπ ${surchargeAmount.toFixed(2)}</strong> 
      <span style="font-size: smaller;color: gray;">
        (${netUnits} √ó ${surcharge} = ${surchargeAmount.toFixed(2)})
      </span><br><br>
      </div>

    Meter Rent: <strong>‚Çπ ${meterCharge.toFixed(2)}</strong><br><br>

    <b>Total Bill (prosumer): ‚Çπ ${total.toFixed(2)}</b><br><br>

    Updated banked balance (UB): <strong>${newBank} units</strong>
    
    
  <div class="pdf-page-break"> </div>
    <!-- ===== Consumer Bill ===== -->
  <div class="avoid-page-break">
      <h3>As a Consumer (Without Export)</h3>
      <br>
    Billing Type: <strong>${connectionType}</strong>, 
    ${consumerImport >= 250 ? 'TOD' : 'Non-TOD'}, 
    <strong>${billmethCons}</strong><br><br>

    Billed Units [I + OC]: ${importUnits} + ${ownSolarDay} = 
      <strong>${consumerImport}</strong><br>

    ${billmethCons === "non-telescopic" 
      ? `Adj_NL Reading [NL + OC]: ${dayTotal}<br>
         Adjusted TOD Units: Adj_NL: <strong>${dayTotal}</strong>, 
         OP: <strong>${todOffpeak}</strong>, 
         PK: <strong>${todPeak}</strong><br>` 
      : ``}

    <br>
    Energy Charge: 
      <strong>${userChoice === "skipped" ? 'NA' : consumerEnergy.toFixed(2)}</strong><br>
    <span style="font-size: smaller; color: gray;">
      ${userChoice === "skipped" 
        ? 'TOD readings to be provided' 
        : consumerEString}
    </span><br><br>
        
    Fixed Charge: <strong>‚Çπ ${consumerFixed.toFixed(2)}</strong> 
      <span style="font-size: smaller;color: gray;">
        (${fixedChargeStr}, ${fixedLabel} slab)
      </span><br>

    Duty (${duty}% of Energy): <strong>‚Çπ ${consumerdutyAmount.toFixed(2)}</strong> 
      <span style="font-size: smaller;color: gray;">
        (${consumerEnergy.toFixed(2)} √ó ${duty}% = ${consumerdutyAmount.toFixed(2)})
      </span><br>

    Fuel Surcharge (${surcharge}/unit): <strong>‚Çπ ${consumersurchargeAmount.toFixed(2)}</strong> 
      <span style="font-size: smaller;color: gray;">
        (${consumerImport} √ó ${surcharge} = ${consumersurchargeAmount.toFixed(2)})
      </span><br><br>    

    Meter Rent: <strong>‚Çπ ${consumerMeter.toFixed(2)}</strong><br><br>

    <b>Total Bill (consumer): ‚Çπ ${userChoice === "skipped" ? 'NA' : consumerTotal.toFixed(2)}</b>
    </div> 

    </div>
     `    
  resultDiv.scrollIntoView({behavior: 'smooth'}); 
    // Optional: Enable debug panel if needed
    // showDebugPanel();
});

});
 

</script>

</body>

</html>


  





