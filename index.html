<!DOCTYPE html>
<html lang="ml">
<head>
  <meta charset="UTF-8">
  <title>KSEB Prosumer Bill Calculator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Malayalam font -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Malayalam&display=swap" rel="stylesheet">
  <!-- PDF download support -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  

<style>
/* ======================================================
   KSEB Prosumer Bill Calculator - Consolidated CSS
   ====================================================== */

/* ===== 1. Base Layout & Typography ==================== */
body {
  font-family: 'Noto Sans Malayalam', Arial, sans-serif;
  margin: 1rem;
  background: #f7f7f7;
}

h1  { color: #1e88e5; font-size: 1.5rem; }
h3  { margin: 0.1rem 0; }
hr  { margin: 0.1rem 0; }

@media (min-width: 600px) {
  h1 { font-size: 2rem; }
}

/* ===== 2. Form Elements =============================== */
select,
input[type="number"],
button {
  font-size: 16px;
  padding: 8px;
  width: 100%;
  max-width: 400px;
  box-sizing: border-box;
  margin-bottom: 10px;
}

input,
select,
textarea {
  line-height: 1.4;
  padding: 8px; /* Prevents mobile zoom on focus */
}

button { cursor: pointer; }

@media (min-width: 768px) {
  select,
  input[type="number"],
  button {
    max-width: 500px;
  }
}

@media (max-width: 767px) {
  select,
  input[type="number"],
  button {
    font-size: 20px;  /* Larger for touch devices */
  }
}

/* Hide buttons and controls when printing */
@media print {
  .no-print { display: none !important; }
}

input,
select,
button,
label {
  max-width: 100% !important;
  box-sizing: border-box;
}

/* ===== 3. Results Output Box =========================== */
.result {
  background: #e3f2fd;
  padding: 1rem;
  margin-top: 1rem;
  border-left: 5px solid #1e88e5;
  word-wrap: break-word;
}

.result h3 {
  margin: 1rem 0;
}

/* ===== 4. Timestamp & Update Info ===================== */
.timestamp {
  font-size: 0.9rem;
  color: #555;
  margin-bottom: 1rem;
}

/* ===== 5. Debug Panel Style =========================== */
.debug {
  background: #fff8dc;
  color: #333;
  font-family: monospace;
  white-space: pre-wrap;
  border: 1px dashed #aaa;
  padding: 1rem;
  margin-top: 1rem;
}

.hidden { display: none; }

/* ===== 6. PDF Download Button Style =================== */
#downloadFullPDF {
  background: #4CAF50;
  color: white;
  border: none;
  padding: 0.75rem;
  font-size: 1rem;
  width: 100%;
  margin-top: 2rem;
}

/* ===== 7. PDF & Print Adjustments ===================== */
#pdfContent {
  transform: scale(0.94);
  transform-origin: top left;
  width: 100%;
}

.result,
.input-section {
  zoom: 0.85;
  transform-origin: top left;
}

/* -- Force page break in PDF -- */
.pdf-page-break {
  page-break-before: always !important;
  break-before: page !important;
  display: block !important;
  margin: 0;
  padding: 0;
  border: none;
  height: 50px;
  background: none;
}

/* -- Avoid page break inside these -- */
.avoid-page-break {
  page-break-inside: avoid !important;
  break-inside: avoid !important;
  -webkit-column-break-inside: avoid !important;
  -moz-column-break-inside: avoid !important;
  display: block !important;
  margin-bottom: 0 !important;
  padding-bottom: 1 !important;
  overflow: visible !important;
}

/* -- Print-only layout overrides -- */
@media print {
  body,
  html,
  #pdfContent {
    width: 90% !important;
  }

  #billForm,
  #downloadFullPDF,
  .timestamp,
  #debugPanel {
    display: none;
  }

  .result { display: block !important; }
}

/* ===== 8. Global Width & Overflow Fix ================= */
html,
body,
#pdfContent {
  width: 100% !important;
  max-width: 100% !important;
  overflow-x: hidden !important;
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

</style>
</head>

<body>
<!-- Hidden field: software last update date -->
<input type="hidden" id="lastUpdated">

<!-- ===== Main PDF Content ====================================================== -->

<!-- Title -->
<h1>KSEB Prosumer Bill Calculator / ‡¥ï‡µÜ.‡¥é‡¥∏‡µç.‡¥á.‡¥¨‡¥ø. ‡¥™‡µç‡¥∞‡µã‡¥∏‡µç‡¥Ø‡µÇ‡¥Æ‡µº ‡¥¨‡¥ø‡µΩ ‡¥ï‡¥æ‡µΩ‡¥ï‡µç‡¥ï‡µÅ‡¥≤‡µá‡¥±‡µç‡¥±‡µº</h1>

<!-- Top Info Bar: Timestamp & Last Update -->
<div style="display: flex; justify-content: space-between; font-size: 0.9rem; color: #555; margin-bottom: 1rem;">
  <div id="timestamp"></div>
  <div id="lastUpdatedDisplay"></div>
</div>

<!-- ===== Bill Input Form ===== -->
<form id="billForm">

  <!-- Connection Type -->
  <label for="connectionType">Connection Type / ‡¥ï‡¥£‡¥ï‡µç‡¥∑‡µª ‡¥§‡¥∞‡¥Ç:</label>
  <select id="connectionType" title="Select your connection type">
    <option value="LT1">LT-1 Domestic / ‡¥°‡µä‡¥Æ‡¥∏‡µç‡¥±‡µç‡¥±‡¥ø‡¥ï‡µç</option>
  </select>

  <!-- Phase Type -->
  <label for="phaseType">Phase Type / ‡¥´‡µá‡¥∏‡µç ‡¥§‡¥∞‡¥Ç:</label>
  <select id="phaseType" title="Select your phase type">
    <option value="single">Single Phase / ‡¥∏‡¥ø‡¥Ç‡¥ó‡¥ø‡µæ ‡¥´‡µá‡¥∏‡µç</option>
    <option value="three">Three Phase / ‡¥§‡µç‡¥∞‡¥ø‡¥´‡µá‡¥∏‡µç</option>
  </select>

  <!-- Previous Bank Balance -->
  <label for="Bank">Previous Bank Balance Units:</label>
  <input type="number" id="Bank" value="0" placeholder="e.g. 10">

  <!-- TOD Availability -->
  <label for="TODAvailability">Is TOD Bill Available? / ‡¥ü‡¥ø‡¥§‡¥ø‡¥í‡¥°‡¥ø ‡¥¨‡¥ø‡µΩ ‡¥≤‡¥≠‡µç‡¥Ø‡¥Æ‡¥æ‡¥£‡µã?</label>
  <select id="TODAvailability" title="Select yes if TOD bill is available">
    <option value="No">No / ‡¥á‡¥≤‡µç‡¥≤</option>
    <option value="Yes">Yes / ‡¥â‡¥£‡µç‡¥ü‡µç</option>
  </select>

  <!-- Import Units (hidden when TOD is enabled) -->
  <div id="importField">
    <label>Units Imported from Grid [I] / ‡¥ó‡µç‡¥∞‡¥ø‡¥°‡¥ø‡µΩ ‡¥®‡¥ø‡¥®‡µç‡¥®‡µÅ‡¥≥‡µç‡¥≥ ‡¥á‡¥Ç‡¥™‡µã‡µº‡¥ü‡µç‡¥ü‡µç:</label>
    <input type="number" id="importUnits"  placeholder="Units imported from grid e.g. 100">
  </div>

  <!-- Export Units (hidden when TOD is enabled) -->
    <div id="exportField">
  <label>Units Exported to Grid [E] / ‡¥ó‡µç‡¥∞‡¥ø‡¥°‡¥ø‡¥≤‡µá‡¥ï‡µç‡¥ï‡µç ‡¥Ö‡¥Ø‡¥ö‡µç‡¥ö ‡¥Ø‡µÇ‡¥£‡¥ø‡¥±‡µç‡¥±‡µÅ‡¥ï‡µæ:</label>
  <input type="number" id="exportUnits" placeholder="Units exported to grid e.g. 100">
   </div>

  <!-- Solar Generation -->
  <label>Total Solar Energy Generation [GM] / ‡¥Æ‡µä‡¥§‡µç‡¥§‡¥Ç ‡¥∏‡µã‡¥≥‡¥æ‡µº ‡¥ä‡µº‡¥ú ‡¥â‡µΩ‡¥™‡¥æ‡¥¶‡¥®‡¥Ç:</label>
  <input type="number" id="Solar" value="0" placeholder="Units of solar generated e.g. 100">

  <!-- TOD Input Fields (visible only when TOD is enabled) -->

<div id="todFields" class="hidden">
  <div style="display:flex; font-weight:bold; margin-bottom:5px;">
    <div style="flex:1;">Units Imported from Grid [I] / ‡¥ó‡µç‡¥∞‡¥ø‡¥°‡¥ø‡µΩ ‡¥®‡¥ø‡¥®‡µç‡¥®‡µÅ‡¥≥‡µç‡¥≥ ‡¥á‡¥Ç‡¥™‡µã‡µº‡¥ü‡µç‡¥ü‡µç</div>
    <div style="flex:1;">Units Exported to Grid [E] / ‡¥ó‡µç‡¥∞‡¥ø‡¥°‡¥ø‡¥≤‡µá‡¥ï‡µç‡¥ï‡µç ‡¥Ö‡¥Ø‡¥ö‡µç‡¥ö ‡¥Ø‡µÇ‡¥£‡¥ø‡¥±‡µç‡¥±‡µÅ‡¥ï‡µæ</div>
  </div>

  <!-- NL Row -->  
     <div style="display:flex; gap:8px;">
    <input type="number" id="todDay"   placeholder="Import NL / ‡¥¶‡¥ø‡¥® ‡¥∏‡¥Æ‡¥Ø ‡¥â‡¥™‡¥≠‡µã‡¥ó‡¥Ç"  style="flex:1;">
    <input type="number" id="EtodDay"  placeholder="Export NL/ ‡¥¶‡¥ø‡¥® ‡¥∏‡¥Æ‡¥Ø ‡¥é‡¥ï‡µç‡¥∏‡µç‡¥™‡µã‡µº‡¥ü‡µç"  style="flex:1;">
  </div>

  <!-- OP Row -->
    <div style="display:flex; gap:8px;">
    <input type="number" id="todOffpeak"   placeholder="Import OP / ‡¥ì‡¥´‡µç-‡¥™‡µÄ‡¥ï‡µç‡¥ï‡µç ‡¥â‡¥™‡¥≠‡µã‡¥ó‡¥Ç" style="flex:1;">
    <input type="number" id="EtodOffpeak"  placeholder="Export OP / ‡¥ì‡¥´‡µç-‡¥™‡µÄ‡¥ï‡µç‡¥ï‡µç ‡¥é‡¥ï‡µç‡¥∏‡µç‡¥™‡µã‡µº‡¥ü‡µç" style="flex:1;">
  </div>

  <!-- PK Row --> 
  <div style="display:flex; gap:8px;">
    <input type="number" id="todPeak"   placeholder="Import PK / ‡¥™‡µÄ‡¥ï‡µç‡¥ï‡µç ‡¥ü‡µà‡¥Ç ‡¥â‡¥™‡¥≠‡µã‡¥ó‡¥Ç" style="flex:1;">
    <input type="number" id="EtodPeak"  placeholder="Export PK / ‡¥™‡µÄ‡¥ï‡µç‡¥ï‡µç ‡¥ü‡µà‡¥Ç ‡¥é‡¥ï‡µç‡¥∏‡µç‡¥™‡µã‡µº‡¥ü‡µç" style="flex:1;">
  </div>
</div>

  <!-- Submit Button -->
  <div style="display: flex; gap: 5px;">
    <button type="submit" class="no-print"
      style="background-color:#007BFF; color:white; border:none; padding:8px 16px; border-radius:4px;">
      Calculate / ‡¥ï‡¥æ‡µΩ‡¥ï‡µç‡¥ï‡µÅ‡¥≤‡µá‡¥±‡µç‡¥±‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥ï
    </button>
  </div>

</form>
<!-- ===== End of Bill Input Form ===== -->

<!-- Calculation Result -->
<div class="result" id="result" style="display:none;"></div>

<!-- Debug Panel (hidden by default) -->
<div id="debugPanel" class="debug hidden"></div>

<!-- PDF Download Button -->
<button id="downloadFullPDF" class="no-print">Download Calculations as PDF</button>

<!-- Latest Tariff Circular -->
<div class="pdf-container" style="margin-top: 10px; margin-bottom: 15px;">
  <span style="font-size:0.9em; color:blue;">
    Latest KSEB Tariff Circular Used for Calculations:
  </span>
  <a href="Tariff Revision Circular 2025-2027-17429697391004759589.pdf" target="_blank">
    üìÑ View Circular
  </a>
</div>

<!-- ===== Custom Alert Box ===== -->
<div id="customAlert"
     style="display:none; position:fixed; top:30%; left:50%; transform:translate(-50%,-50%);
            background:#fff; border:2px solid red; padding:20px; z-index:1000; box-shadow:0 0 10px #000; color:red;">
  <h3 style="margin-top:0;">Alert!</h3>
  <div id="customAlertMessage"></div>
  <button onclick="document.getElementById('customAlert').style.display='none'">Close</button>
</div>
<!-- ===== End of Main PDF Content ===== -->

  

<script>

/* ================Initial values assumed before functions ====================================== */
  const updatedDate = "20 Aug 2025"; // Last Software update Date
  let NonTelStartUnit = 250; // Units above 250 are taiken for non-Telescopic Billing
  let ConTODStartUnit = 500; // Units above 500 then TOD rates apply for consumer
  let ProsTODStartUnit = 250; // Net Units above 250, then TOD rates apply for prosumer
  
  let slabs = [], chargesTable = [], todRates = {};
  let fixedChargeTable = [], meterChargeTable = [];
  let userChoice = "";
  let cachedTodBaseTable = null;  // // will hold the entire parsed table
  let cachedTodBaseRate  = null;  // will hold the final rate when calculated later
  let debugLog = [];


/* ======================================================
   KSEB Prosumer Bill Calculator - JavaScript
   Consolidated and Fully Annotated
   ====================================================== */

document.addEventListener('DOMContentLoaded', function () {

    /* ------------------------------------------------------
     1. Initialisation (timestamp and last-updated display)
     ------------------------------------------------------ */
  const now = new Date();
  document.getElementById('timestamp').textContent =
    `Date: ${now.toLocaleDateString()} | Time: ${now.toLocaleTimeString()}`;

  document.getElementById('lastUpdated').value = updatedDate;
  
    const lastUpdatedValue = document.getElementById('lastUpdated').value;
  document.getElementById('lastUpdatedDisplay').textContent =
    `Software Last Updated: ${lastUpdatedValue}`;

  /* ------------------------------------------------------
     2. TOD Availability Toggle (controls which fields show)
     ------------------------------------------------------ */
  const todDropdown      = document.getElementById('TODAvailability');
  const todSection       = document.getElementById('todFields');
  const importField      = document.getElementById('importField');
  const importUnitsInput = document.getElementById('importUnits');
  const exportField      = document.getElementById('exportField')
  const exportUnitsInput = document.getElementById('exportUnits');

  // Show/hide TOD / Import fields based on dropdown value
  function handleTODToggle() {
    if (todDropdown.value === 'Yes') {
      todSection.classList.remove('hidden');
      importField.classList.add('hidden');
      exportField.classList.add('hidden');
      importUnitsInput.removeAttribute('required')
      exportUnitsInput.removeAttribute('required');
    } else {
      todSection.classList.add('hidden');
      importField.classList.remove('hidden');
      exportField.classList.remove('hidden');
      importUnitsInput.setAttribute('required', '')
      exportUnitsInput.setAttribute('required', '');
    }
  }
  todDropdown.addEventListener('change', handleTODToggle);
  handleTODToggle();  // run on page load

  /* ------------------------------------------------------
     3. Custom Alert Utility (for messages that don't need Yes/No)
     ------------------------------------------------------ */
  function showCustomAlert(message) {
    document.getElementById("customAlertMessage").innerHTML = message;
    document.getElementById("customAlert").style.display = "block";
  }

  /* ------------------------------------------------------
     4. Custom Yes/No Prompt Utility (returns a Promise<boolean>)
     ------------------------------------------------------ */
  function showYesNoPrompt(message) {
    return new Promise((resolve) => {
      const modal = document.createElement("div");
      modal.id = "customPrompt";
      Object.assign(modal.style, {
        position: "fixed",
        top: "0", left: "0", width: "100%", height: "100%",
        backgroundColor: "rgba(0,0,0,0.5)", display: "flex",
        justifyContent: "center", alignItems: "center", zIndex: "9999"
      });

      modal.innerHTML = `
        <div style="background:#fff; padding:20px; border-radius:8px; max-width:500px; text-align:center">
          <div style="margin-bottom:10px;">${message}</div>
          <button id="yesBtn" style="margin-right:20px; padding:6px 14px;">Yes</button>
          <button id="noBtn"  style="padding:6px 14px;">No</button>
        </div>
      `;

      document.body.appendChild(modal);
      document.getElementById("yesBtn").onclick = () => { modal.remove(); resolve(true);  };
      document.getElementById("noBtn").onclick  = () => { modal.remove(); resolve(false); };
    });
  }

  /* ------------------------------------------------------
     5. PDF Download Handler
     ------------------------------------------------------ */
  document.getElementById('downloadFullPDF').addEventListener('click', () => {
    // Hide all .no-print elements
    document.querySelectorAll('.no-print').forEach(el => el.style.display = 'none');

    const element = document.getElementById('pdfContent');
    const opt = {
      margin: 0.3,
      filename: `KSEB_Bill_${new Date().toISOString().split('T')[0]}.pdf`,
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: {
        scale: 3,
        scrollY: 0,
        useCORS: true,
        windowWidth:  element.scrollWidth,
        windowHeight: element.scrollHeight
      },
      jsPDF:  { unit: 'in', format: 'a4', orientation: 'portrait' },
      pagebreak: {
        mode: ['css', 'legacy'],
        before: '.pdf-page-break',   // Force new page before this element
        avoid:  '.avoid-page-break'  // Prevent page break inside these elements
      }
    };

    html2pdf().set(opt).from(element).save().then(() => {
      // Restore no-print elements after PDF is generated
      document.querySelectorAll('.no-print').forEach(el => el.style.display = '');
    });
  });

  /* ------------------------------------------------------
     6. CSV Loading and Parsing Helper Functions
     ------------------------------------------------------ */

   // Generic CSV loader
  function loadCSV(file, parser) {
    return fetch(file)
      .then(res  => res.ok ? res.text() : Promise.reject(`Failed to load ${file}`))
      .then(text => { parser(text); debugLog.push(`[LOADED] ${file}`); })
      .catch(err  => { console.error(`[CSV ERROR] ${file}:`, err);
                       debugLog.push(`[ERROR] ${err}`); });
  }

  // Domestic Slabs (0‚Äì250, 250‚Äì500 etc.)
  function parseSlabs(text) {
    const lines = text.trim().split('\n').slice(1);
    slabs = lines.map(line => {
      const [range, rate] = line.split(',');
      const upper = parseInt(range.split('-')[1] || (range.match(/\d+/g) || [0])[0]);
      return { limit: upper, rate: parseFloat(rate) };
    });
  }

  // TOD Rates (NL, OP, PK)
  function parseTODRates(text) {
    const lines = text.trim().split('\n').slice(1);
    todRates = {};
    lines.forEach(line => {
      const [label, rate] = line.split(',');
      todRates[label.trim().toLowerCase()] = parseFloat(rate);
    });
  }

  // TOD Base Tariff (0‚Äì300, 0‚Äì350, Above 500)
  function parseTODTariff(text) {
    const lines = text.trim().split('\n').slice(1);
    return lines.map(line => {
      const [range, base] = line.split(',').map(v => v.trim());
      if (/above/i.test(range)) {
        return { upper: Infinity, base: parseFloat(base) };
      }
      const nums  = range.match(/\d+/g);
      const upper = nums ? parseInt(nums[1]) : 0;
      return { upper, base: parseFloat(base) };
    });
  }

  // Other Charges (Duty, Surcharge)
  function parseCharges(text) {
    const lines = text.trim().split('\n').slice(1);
    chargesTable = lines.map(line => {
      const [label, duty, surcharge] = line.split(',');
      return { label: label.trim(), duty: parseFloat(duty), surcharge: parseFloat(surcharge) };
    });
  }

  // Fixed Charges
  function parseFixedCharges(text) {
    const lines = text.trim().split('\n').slice(1);
    fixedChargeTable = lines.map(line => {
      const [slab, single, three] = line.split(',');
      let min = 0, max = Infinity;
      if (slab.includes('-'))        { [min, max] = slab.split('-').map(Number); }
      else if (/above/i.test(slab))  { min = parseInt(slab.match(/\d+/)?.[0]);   }
      return { min, max, label: slab.trim(), single: parseFloat(single), three: parseFloat(three) };
    });
  }

  // Meter Charges
  function parseMeterCharges(text) {
    const lines = text.trim().split('\n').slice(1);
    meterChargeTable = lines.map(line => {
      const [type, single, three] = line.split(',');
      return { label: type.trim(), single: parseFloat(single), three: parseFloat(three) };
    });
  }

  /* ------------------------------------------------------
     7. Utility Functions (Fixed Charge / Meter / Other)
     ------------------------------------------------------ */
  function getFixedCharge(phaseType, totalUnits) {
    for (let row of fixedChargeTable) {
      if (totalUnits >= row.min && totalUnits <= row.max) {
        return { value: phaseType === "three" ? row.three : row.single, label: row.label };
      }
    }
    return { value: 0, label: "Not found" };
  }

 function getFixedChargeString(importUnits, ownSolarDay) {
    const total = importUnits + ownSolarDay;
    return `I:${importUnits} + OC:${ownSolarDay} = ${total}`;
    }


  function getMeterRent(connectionType, phaseType) {
    for (let row of meterChargeTable) {
      if (row.label === connectionType) {
        return { value: phaseType === "three" ? row.three : row.single,
                 label: `${row.label}-${phaseType}` };
      }
    }
    return { value: 0, label: "Not found" };
  }

  function getOtherCharges(connectionType) {
    for (let row of chargesTable) {
      if (row.label === connectionType) {
        return { duty: row.duty, surcharge: row.surcharge };
      }
    }
    return { duty: 0, surcharge: 0 };
  }

  /* ------------------------------------------------------
     8. Billing Type (Prosumer / Consumer Mode)
     ------------------------------------------------------ */
  function getBillingTypeProsumer(importUnits, exportUnits, Solar, Bank) {
    const netUnits = importUnits - exportUnits - Bank;
    return { billtype: (netUnits <= NonTelStartUnit ? "telescopic" : "non-telescopic") };
  }

  function getBillingTypeConsumer(importUnits, exportUnits, Solar) {
    const totalUnits = importUnits + (Solar - exportUnits);
    return { billtype: (totalUnits > NonTelStartUnit ? "non-telescopic" : "telescopic") };
  }


/* ------------------------------------------------------
   9. Domestic Energy Charge (Telescopic Slab Calculation)
   ------------------------------------------------------ */
function calculateDomesticCharge(units) {
  /*
    Goes through the domestic slab table and applies slab-wise
    rate up to the upper limit of each slab.
  */
  let total = 0;
  let prevLimit = 0;

  for (let slab of slabs) {
    if (units <= 0) break;
    const slabUnits = Math.min(units, slab.limit - prevLimit);
    total += slabUnits * slab.rate;
    units -= slabUnits;
    prevLimit = slab.limit;
  }

  return total;
}

// Same as above but returns the breakdown as a string.
function calculateDomesticChargeString(units) {
  let prevLimit = 0;
  let parts = [];

  for (let slab of slabs) {
    if (units <= 0) break;
    const slabUnits = Math.min(units, slab.limit - prevLimit);
    const charge   = slabUnits * slab.rate;
    parts.push(`${slabUnits} units * ‚Çπ${slab.rate.toFixed(2)} = ‚Çπ${charge.toFixed(2)}`);
    units -= slabUnits;
    prevLimit = slab.limit;
  }

  return parts.length
    ? parts.join('<br> + ')
    : '0 units billed';
}

/* ------------------------------------------------------
   10. TOD Tariff Lookup (returns { upper, base })
   ------------------------------------------------------ */
function getTodBaseRate(totalImport) {
  /*
    Loops through cachedTodBaseTable and returns the first
    matching slab object for which totalImport <= upper.
    (Example: totalImport = 325 ‚Üí upper = 350, base = 7.6)
  */
  if (!cachedTodBaseTable) return null;

  for (let row of cachedTodBaseTable) {
    if (totalImport <= row.upper) {
      return { base: row.base, upper: row.upper };
    }
  }
  return null; // no match found
}

/* ------------------------------------------------------
   11. TOD Energy Charge (Prosumer Mode & Consumer Mode)
   ------------------------------------------------------ */
function calculateTODCharge(day, peak, offpeak, NET, isConsumer) {

 const threshold = isConsumer ? ConTODStartUnit : ProsTODStartUnit;

if (NET <= threshold) {
    ['nl', 'pk', 'op'].forEach(key => { if (todRates.hasOwnProperty(key)) todRates[key] = 1; });
  }
    /*
    NET = (day + offpeak + peak) after export adjustments.
    Base rate depends on NET (from getTodBaseRate).
    Multipliers = todRates.nl / todRates.pk / todRates.op
  */
  const todBaseRate = getTodBaseRate(NET).base;

  return todBaseRate * (
      (day     * todRates.nl) +
      (peak    * todRates.pk) +
      (offpeak * todRates.op)
  );
}


/* ------------------------------------------------------
   12. Detailed breakdown string for Consumer mode
   ------------------------------------------------------ */

function getTODCalculationString(day, peak, offpeak, NET, isConsumer) {

  const threshold = isConsumer ? ConTODStartUnit : ProsTODStartUnit;

  if (NET <= threshold) {
    ['nl', 'pk', 'op'].forEach(key => { if (todRates.hasOwnProperty(key)) todRates[key] = 1; });
  }

  const todBaseRate = getTodBaseRate(NET).base;
  let parts = [];

  if (day)     parts.push(`NL: ${day} √ó ‚Çπ${todBaseRate} √ó ${todRates.nl} = ‚Çπ${(day * todBaseRate * todRates.nl).toFixed(2)}`);
  if (offpeak) parts.push(`OP: ${offpeak} √ó ‚Çπ${todBaseRate} √ó ${todRates.op} = ‚Çπ${(offpeak * todBaseRate * todRates.op).toFixed(2)}`);
  if (peak)    parts.push(`PK: ${peak} √ó ‚Çπ${todBaseRate} √ó ${todRates.pk} = ‚Çπ${(peak * todBaseRate * todRates.pk).toFixed(2)}`);

    // Add "+" symbol between parts
  if (parts.length > 1) {
    for (let i = 0; i < parts.length - 1; i++) parts[i] += ' +';
  }

  return parts.join('<br>') || '0 units billed';
}

/* ------------------------------------------------------
   13. Net Units import calculation for Prosumer
   ------------------------------------------------------ */
/**
 * Calculates Actual Import, Net Import, Adjusted Import (after using bank),
 * and Current Bank balance.
 *
 * - importTOD / exportTOD are objects with {day, offpeak, peak}
 * - bank is the previous banked balance (number)
 *
 * Returns: { actualImport, netImport, adjImport, currentBank }
 */
function getNetImportTOD(importTOD, exportTOD, bank) {

  // STEP 1: Find actual import AND per-zone export surplus
  const actualImport = [];
  const extraExportPerZone = [];

  // NL
  actualImport[0] = Math.max(0, importTOD.day - exportTOD.day);
  extraExportPerZone[0] = Math.max(0, exportTOD.day - importTOD.day);

  // OP
  actualImport[1] = Math.max(0, importTOD.offpeak - exportTOD.offpeak);
  extraExportPerZone[1] = Math.max(0, exportTOD.offpeak - importTOD.offpeak);

  // PK
  actualImport[2] = Math.max(0, importTOD.peak - exportTOD.peak);
  extraExportPerZone[2] = Math.max(0, exportTOD.peak - importTOD.peak);

  console.log("‚ñ∂ ActualImport =", actualImport);
  console.log("‚ñ∂ ExtraExportPerZone =", extraExportPerZone);

  // STEP 2: Total remaining export (add all per-zone extras)
  let remainingExport = extraExportPerZone.reduce((s,v)=>s+v, 0);

  // STEP 3: Subtract remaining export from actualImport (NL‚ÜíOP‚ÜíPK)
  let netImport = [...actualImport];
  for (let i = 0; i < netImport.length && remainingExport > 0; i++) {
    const used = Math.min(netImport[i], remainingExport);
    netImport[i] -= used;
    remainingExport -= used;
  }

  // STEP 4: Apply Bank (NL‚ÜíOP‚ÜíPK)
  let adjImport = [...netImport];
  let currentBank = bank;
  for (let i = 0; i < adjImport.length && currentBank > 0; i++) {
    const used = Math.min(adjImport[i], currentBank);
    adjImport[i] -= used;
    currentBank -= used;
  }

  // STEP 5: Any still remaining export goes to bank
  if (remainingExport > 0) {
    currentBank += remainingExport;
  }

  console.log("‚ñ∂ netImport =", netImport);
  console.log("‚ñ∂ adjImport =", adjImport);
  console.log("‚ñ∂ updatedBank =", currentBank);

  return { actualImport, netImport, adjImport, currentBank };
}


/* ------------------------------------------------------
   14. Net Energy Adjustments (Export / Bank Set-off)
   ------------------------------------------------------ */
function getEnergy(importTOD, exportTOD, Bank) {
  /*
     importTOD  = {day, offpeak, peak}
     exportTOD  = {day, offpeak, peak}
     bank       = previous bank balance

     1. getNetImportTOD() handles export and bank adjustment
     2. use adjusted import values to calculate final TOD charge
  */

  const { adjImport, currentBank } = getNetImportTOD(importTOD, exportTOD, Bank);

  // Zone-wise adjusted import values
  const adjDay     = adjImport[0];
  const adjOffpeak = adjImport[1];
  const adjPeak    = adjImport[2];

  // Total net import (after export + bank adjustment)
  const NET = adjDay + adjOffpeak + adjPeak;

  // Prosumer TOD energy charge
  const energyCharge  = calculateTODCharge(adjDay, adjPeak, adjOffpeak, NET);
  const EChargeString = getTODCalculationString(adjDay, adjPeak, adjOffpeak, NET);

  return {
    energyCharge,
    EChargeString,
    adjDay,
    adjOffpeak,
    adjPeak,
    currentBank
  };
}

/* ------------------------------------------------------
   14. Slab Label for upper limit to change from infinity to above 500
   ------------------------------------------------------ */

function getSlabLabel(totalUnits) {
  const slab = getTodBaseRate(totalUnits);
  const label = (slab.upper === Infinity) ? "Above 500" : slab.upper;
  return { slabObj: slab, label: label };
}



/* ======================================================
   Render Blocks (Prosumer and Consumer billing sections)
   ====================================================== */

// -- Render Prosumer Billing Block -----------------------------------------
function renderProsumerBillingBlock(billmethPros, netUnits, ProsESlab, slabEPros, todRates) {
  if (billmethPros !== "non-telescopic") return `
  <span style="font-size: smaller; color: green;">
      Billing: ${billmethPros} for ${netUnits} units <br> </span>`;

  const slabText =
    (ProsESlab.upper === Infinity)
      ? `Slab: ${slabEPros}, Rate: ${ProsESlab.base}`
      : `Slab: 0 - ${ProsESlab.upper}, Rate: ${ProsESlab.base}`;

  return `
    <span style="font-size: smaller; color: green;">
      Billing: ${billmethPros} for ${netUnits} units <br>
      ${slabText} <br>
      TOD Rates: NL: ${todRates.nl}, OP: ${todRates.op}, PK: ${todRates.nl} <br>
    </span>
  `;
}

// -- Render Consumer Billing Block -----------------------------------------
const CTodRStart = 500; // threshold after which TOD multipliers differ

function renderConsumerBillingBlock(billmethCons, consumerImport, ConsESlab, slabECons, todRates) {
  if (billmethCons !== "non-telescopic") return "";

  const slabText =
    (ConsESlab.upper === Infinity)
      ? `Slab: ${slabECons}, Rate: ${ConsESlab.base}`
      : `Slab: 0 - ${ConsESlab.upper}, Rate: ${ConsESlab.base}`;

  // NOTE: Only show the "Different TOD rate" note for slabs <= 500
  const diffTodNote =
    (ConsESlab.upper <= CTodRStart)
      ? `<br>Different TOD rates only above ${CTodRStart} units`
      : "";

  return `
    <span style="font-size: smaller; color: green;">
      Billing: ${billmethCons} for ${consumerImport} units <br>
      ${slabText} <br>
      TOD Rates: NL: ${todRates.nl}, OP: ${todRates.op}, PK: ${todRates.nl}
      ${diffTodNote}
    </span>
  `;
}

// -- Render TOD import breakdowwn Block -----------------------------------------
/**
 * Renders the TOD import breakdown for Prosumer mode.
 * Shows Actual, Net and Adjusted values (NL/OP/PK)
 * Only when: (billing is non-telescopic) AND (netUnits > 0)
 */
function renderProsumerTODBreakdown(billmethPros, netUnits, actualImport, netImport, adjImport) {
  // ‚úÖ render only when BOTH conditions are satisfied
  if (billmethPros === "non-telescopic" && netUnits > 0) {
    return `
    <br>
      Actual Import:    NL: <span style="font-size: smaller; color: green;">${actualImport[0]}</span>,
                        OP: <span style="font-size: smaller; color: green;">${actualImport[1]}</span>,
                        PK: <span style="font-size: smaller; color: green;">${actualImport[2]}</span><br>
      Net TOD:          NL: <span style="font-size: smaller; color: green;">${netImport[0]}</span>,
                        OP: <span style="font-size: smaller; color: green;">${netImport[1]}</span>,
                        PK: <span style="font-size: smaller; color: green;">${netImport[2]}</span><br>
      Bank Adj: <strong>NL: <span style="font-size: smaller; color: green;">${adjImport[0]}</span></strong>,
                <strong>OP: <span style="font-size: smaller; color: green;">${adjImport[1]}</span></strong>,
                <strong>PK: <span style="font-size: smaller; color: green;">${adjImport[2]}</span></strong><br>
    `;
  }

  // Otherwise, return empty (no output)
  return "";
}


// --------------------------------------------------------------
// Setup billing: loads all required CSV tables and shows/hides
// TOD fields depending on import units
// --------------------------------------------------------------
async function setupBilling(importUnits) {

  // Load all CSV files (runs in parallel using Promise.all)
  await Promise.all([
    loadCSV('fixed_charge.csv', parseFixedCharges),
    loadCSV('meter_charges.csv',  parseMeterCharges),
    loadCSV('other_charges.csv',  parseCharges),
    loadCSV('tariff_tod.csv',     parseTODRates),
    loadCSV('tariff_domestic_telescopic.csv', parseSlabs),

    // Load and cache the TOD base table
    loadCSV('tariff_tod_base.csv', function(text) {
      cachedTodBaseTable = parseTODTariff(text);
      console.log("TOD Base Table Cached:", cachedTodBaseTable);
    })
  ]);


  // ----------------------------------------------
  // Show or hide TOD input fields
  // ----------------------------------------------
  if (importUnits > 250) {
    // TOD applicable ‚Üí show the fields
    document.getElementById('todFields').classList.remove('hidden');
  } else {
    // Non-TOD ‚Üí hide the fields
    document.getElementById('todFields').classList.add('hidden');
  }
}


  // ============================================
// Form Submit Event: Main Calculation Handler
// ============================================
document.getElementById('billForm').addEventListener('submit', async function (e) {
  e.preventDefault();

  // ---------------------------
  // 1. Retrieve and Parse Inputs
  // ---------------------------
  const connectionType   = document.getElementById('connectionType').value;
  const phaseType        = document.getElementById('phaseType').value;
  const exportUnitsInput = parseFloat(document.getElementById('exportUnits').value) || 0;
  const importUnitsInput = parseFloat(document.getElementById('importUnits').value) || 0;
  const Solar            = parseFloat(document.getElementById('Solar').value) || 0;
  const Bank             = parseFloat(document.getElementById('Bank').value) || 0;
  const TODAvailability  = document.getElementById('TODAvailability').value.trim().toLowerCase();

  // TOD-specific import inputs
  const todDay     = parseFloat(document.getElementById('todDay').value) || 0;
  const todOffpeak = parseFloat(document.getElementById('todOffpeak').value) || 0;
  const todPeak    = parseFloat(document.getElementById('todPeak').value) || 0;

 // TOD-specific export inputs
  const EtodDay     = Number(document.getElementById('EtodDay').value || 0);
  const EtodOffpeak = Number(document.getElementById('EtodOffpeak').value || 0);
  const EtodPeak    = Number(document.getElementById('EtodPeak').value || 0);

  // ---------------------------
  // 2. Determine Import Units
  // ---------------------------
  let importUnits = 0;  let exportUnits = 0;   let netUnits = 0;   let newBank = 0; //  declare the variables
  let netImpUnits = 0; 

  let importTOD = { day:0, offpeak:0, peak:0 };   let exportTOD = { day:0, offpeak:0, peak:0 };
  let ProsNetImportData;   


  if (TODAvailability === "yes") {

    importUnits = todDay + todOffpeak + todPeak;
    exportUnits = EtodDay + EtodOffpeak + EtodPeak;

        
        //  Core Prosumer Calculations for TOD reading        
  
         exportTOD = {day:EtodDay, offpeak: EtodOffpeak, peak: EtodPeak};
         importTOD = {day: todDay, offpeak:  todOffpeak, peak:  todPeak};
         ProsNetImportData = getNetImportTOD (importTOD, exportTOD, Bank);
    
        //------Import Unit calculations----

          actualImport = ProsNetImportData.actualImport; // zone wise import - export 
          netImport    = ProsNetImportData.netImport; // actual import - extra export in any zone 
          adjImport    = ProsNetImportData.adjImport; // net import - bank in any zone 
          netImpUnits  = netImport[0] + netImport[1] + netImport[2];     // N = I - E
          netUnits     = adjImport[0] + adjImport[1] + adjImport[2]; // N - B
          newBank      = ProsNetImportData.currentBank;   // UB       


  } else {

    //  Core Prosumer Calculations for non-TOD reading

    importUnits = importUnitsInput;
    exportUnits = exportUnitsInput;
    console.log("‚ñ∂ exportUnitsInput =", exportUnitsInput);
    console.log("‚ñ∂ exportUnits =", exportUnits);

    netUnits  = Math.max(0, importUnits - (Bank + exportUnits)); // N - B
    newBank = Math.max(0, Bank + exportUnits - importUnits); 

    console.log("‚ñ∂ netUnits =", netUnits);
    console.log("‚ñ∂ exportUnits =", exportUnits);

  }

  if (isNaN(importUnits)) {
    alert("Please enter a valid import unit value.");
    return;
  }

 
  await setupBilling(importUnits);
  
           
    const ownSolarDay  = Solar - exportUnits;                        // Self-used solar
    const totalUnits   = importUnits + ownSolarDay;                  // I + OC
    const consumerImport = totalUnits;                               // Consumer total usage
  

  // Billing type for prosumer
  const billmethPros = getBillingTypeProsumer(importUnits, exportUnits, Solar, Bank).billtype;

  // Fixed & Meter charges
  const meterInfo      = getMeterRent(connectionType, phaseType);
  const fixedInfo      = getFixedCharge(phaseType, totalUnits);
  const fixedChargeStr = getFixedChargeString(importUnits, ownSolarDay);
  const { value: meterCharge } = meterInfo;
  const { value: fixedCharge, label: fixedLabel } = fixedInfo;

  
  // Other charges (duty, surcharge)
  const { duty, surcharge } = getOtherCharges(connectionType);

  // ---------------------------
  // 5. Energy Charge Calculation (Prosumer)
  // ---------------------------
  let energyCharge = 0, EChargeString = "";
  let adjDay = 0, adjOffpeak = 0, adjPeak = 0;
  let dayTotal = 0;
  isConsumer = false;
  
  
  if (netUnits > NonTelStartUnit) {
    // Non-telescopic (TOD) billing
    const energyResult = getEnergy(importTOD, exportTOD, Bank);
    energyCharge = energyResult.energyCharge;
    EChargeString = energyResult.EChargeString;
    adjDay = energyResult.adjDay;
    adjOffpeak = energyResult.adjOffpeak;
    adjPeak = energyResult.adjPeak;

    console.log("‚ñ∂ energyCharge non tel =", energyCharge);

  } else {
    // Telescopic billing
    energyCharge = calculateDomesticCharge(netUnits);
    EChargeString = calculateDomesticChargeString(netUnits);

     console.log("‚ñ∂ energyCharge tel =", energyCharge);
  }

  // Duty & Surcharge
  const dutyAmount      = energyCharge * duty / 100;
  const surchargeAmount = surcharge * netUnits;

  // Total Prosumer Bill
  const total = energyCharge + fixedCharge + meterCharge + dutyAmount + surchargeAmount;

  // ---------------------------
  // 6. Load Tariff Data (Consumer Mode)
  // ---------------------------
  await setupBilling(consumerImport);

// -------------------------------------------------------------
// 7. Consumer Mode Pre-checks (get meter/fixed charges and prompt user)
// -------------------------------------------------------------

let consumerEnergy = 0,
    consumerFixed  = 0,
    consumerMeter  = 0,
    consumerEString = "";

// Get meter and fixed charge information
const consumerMeterInfo = getMeterRent(connectionType, phaseType);
const consumerFixedInfo = getFixedCharge(phaseType, consumerImport);

consumerMeter = consumerMeterInfo.value;
consumerFixed = consumerFixedInfo.value;

// Auto-set daytime value if TOD available and user has not chosen yet
if (userChoice === "" && TODAvailability === "yes" && consumerImport >= 250) {
  dayTotal = todDay + ownSolarDay;
}

// Prompt only when TOD is not available and import >=250
if (TODAvailability === "no" && consumerImport >= 250 && userChoice === "") {
  const message = `üìå Do you want to skip estimating bill as a Consumer?<br>
  ‡¥®‡¥ø‡¥ô‡µç‡¥ô‡µæ ‡¥â‡¥™‡¥≠‡µã‡¥ï‡µç‡¥§‡µÉ ‡¥¨‡¥ø‡µΩ ‡¥ï‡¥£‡¥ï‡µç‡¥ï‡¥æ‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥®‡¥§‡µç ‡¥í‡¥¥‡¥ø‡¥µ‡¥æ‡¥ï‡µç‡¥ï‡¥£‡µã?`;
  const proceed = await showYesNoPrompt(message);
  userChoice = proceed ? "skipped" : "need";
}

// -------------------------------------------------------------
// 8. Consumer Mode Adjustments (when user wants the consumer calculation)
// -------------------------------------------------------------
if (userChoice === "need" && TODAvailability === "no" && consumerImport >= 250) {

  // No TOD values entered
  if (todDay === 0 && todPeak === 0 && todOffpeak === 0) {
    showCustomAlert(`
      <br>‡¥â‡¥™‡¥≠‡µã‡¥ï‡µç‡¥§‡¥æ‡¥µ‡¥æ‡¥Ø‡¥ø ‡¥ï‡¥£‡¥ï‡µç‡¥ï‡¥æ‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥®‡¥§‡¥ø‡¥®‡¥æ‡¥Ø‡¥ø ‡¥Æ‡µä‡¥§‡µç‡¥§‡¥Ç ‡¥Ø‡µÇ‡¥£‡¥ø‡¥±‡µç‡¥±‡µÅ‡¥ï‡µæ (I + OC) [${consumerImport} ‡¥Ø‡µÇ‡¥£‡¥ø‡¥±‡µç‡¥±‡µÅ‡¥ï‡µæ]
      Œ§ŒüD ‡¥∞‡µÄ‡¥§‡¥ø ‡¥Ö‡¥®‡µÅ‡¥∏‡¥∞‡¥ø‡¥ö‡µç‡¥ö‡µÅ ‡¥®‡µΩ‡¥ï‡¥£‡¥Ç. ‡¥∏‡µç‡¥µ‡¥Ø‡¥Ç ‡¥â‡¥™‡¥Ø‡µã‡¥ó‡¥ø‡¥ö‡µç‡¥ö ‡¥∏‡µã‡¥≥‡¥æ‡µº: <b>${ownSolarDay} ‡¥Ø‡µÇ‡¥£‡¥ø‡¥±‡µç‡¥±‡µÅ‡¥ï‡µæ</b>.
    `);
    return;
  }

  const sumImport = todDay + todPeak + todOffpeak;

  // Validate: Daytime TOD units must be ‚â• own solar usage
  if (todDay < ownSolarDay) {
    alert(`As a Consumer, Daytime TOD units (NL) must be ‚â• Own Solar Use (GM - E) = ${ownSolarDay} units.`);
    return;
  }

  // Validate: Total TOD units should match total import units
  if (sumImport !== totalUnits) {
    alert(`Mismatch: Total TOD units (${sumImport}) ‚â† Total import units (${totalUnits}).`);
    return;
  }

  // Set consumer daytime units to user-entered TOD Day value
  dayTotal = todDay;

} else if (userChoice === "need" && TODAvailability === "yes" && consumerImport >= 250) {
  // If TOD bill is available, daytime = TOD Day + ownSolarDay
  dayTotal = todDay + ownSolarDay;
}

  // ---------------------------
  // 9. Consumer Energy Calculation
  // ---------------------------
  isConsumer = true;
  
  const billmethCons = getBillingTypeConsumer(importUnits, exportUnits, Solar, Bank).billtype;

  if (billmethCons === "telescopic") {
    consumerEnergy  = calculateDomesticCharge(consumerImport);
    consumerEString = calculateDomesticChargeString(consumerImport);
  }

  if (billmethCons === "non-telescopic") {
    let NET = dayTotal+ todPeak+ todOffpeak;
    consumerEnergy  = calculateTODCharge(dayTotal, todPeak, todOffpeak, NET, isConsumer);
    consumerEString = getTODCalculationString(dayTotal, todPeak, todOffpeak, NET, isConsumer);     
     }
     
    
// -------------------------------------------
// 10. Determine Prosumer slab (based on netUnits)
// -------------------------------------------

const prosInfo = getSlabLabel(netUnits);
const ProsESlab = prosInfo.slabObj;
const slabEPros = prosInfo.label;  // returns a matching slab object {upper, base}

// -------------------------------------------
// 11. Determine Consumer slab (based on NETCons)
// -------------------------------------------
let NETCons = dayTotal + todPeak + todOffpeak;     // total TOD consumption as consumer
const consInfo = getSlabLabel(NETCons);
const ConsESlab = consInfo.slabObj;
const slabECons = consInfo.label;

// -------------------------------------------
// 12. Duty, Surcharge, and Total Consumer Bill
// -------------------------------------------
const consumerdutyAmount      = (consumerEnergy * duty) / 100;
const consumersurchargeAmount = surcharge * consumerImport;

const consumerTotal = consumerEnergy
                     + consumerFixed
                     + consumerMeter
                     + consumerdutyAmount
                     + consumersurchargeAmount;


  // =============================
// 13. Render Calculation Result
// =============================
const resultDiv = document.getElementById('result');
resultDiv.style.display = 'block';


// Build HTML output
resultDiv.innerHTML = `
<div id="pdfContent">

  <!-- ===== Title ===== -->
  <h3 style="color: blue;">KSEB Prosumer Bill Calculator</h3>

  <!-- Timestamp and Revision Note -->
  <span style="font-size: smaller; color: purple;">
    Date: ${now.toLocaleDateString()} | Time: ${now.toLocaleTimeString()} <br>
    Software Last Updated: ${lastUpdatedValue}
  </span>
  <br><br>

  <!-- ===== Input Summary ===== -->
  <h3>Input Values</h3>
  Connection Type: <strong>${connectionType}</strong>,
  Phase Type: <strong>${phaseType}</strong><br><br>

  Is TOD bill available? <strong>${TODAvailability.charAt(0).toUpperCase() + TODAvailability.slice(1)}</strong><br><br>

  <!-- ===== Show TOD Table if TOD available or Import >=250 ===== -->
  ${
    (TODAvailability === "yes" || consumerImport >= 250)
      ? `
        ${
          TODAvailability === "yes"
            ? `TOD bill reading`
            : `User-entered TOD values for estimating consumer bill`
        }
        <br><br>

        ${
          /* Prosumer telescopic (TOD not available) => show comparison table */
          billmethPros === "telescopic" && TODAvailability === "no"
            ? `
              <!-- Table: Prosumer NA vs Consumer TOD values -->
              <table style="border-collapse: collapse; margin-bottom: 10px; width: auto; font-family: monospace; font-size: 16px;">
                <thead>
                  <tr><th>Time Slot</th><th style="padding-right: 6ch;">As Prosumer</th><th>As Consumer</th></tr>
                </thead>
                <tbody>
                  <tr><td>Normal/Day Time Units</td><td>NA</td><td>${userChoice === "skipped" ? 'NA' : `${todDay} (NL + OC)`}</td></tr>
                  <tr><td>Off Peak Units (OP)</td><td>NA</td><td>${userChoice === "skipped" ? 'NA' : `${todOffpeak}`}</td></tr>
                  <tr><td>Peak Units (PK)</td><td>NA</td><td>${userChoice === "skipped" ? 'NA' : `${todPeak}`}</td></tr>
                </tbody>
              </table>              
            `
            : `
              <!-- Table: TOD Import and Export values -->
<table style="border-collapse: collapse; margin-bottom: 10px; width: auto; font-family: monospace; font-size: 16px;">
  <thead>
    <tr>
      <th style="text-align:left; padding-right:12ch;">Time Slot</th>
      <th style="text-align:left; padding-right:6ch;">Import</th>
      <th style="text-align:left;">Export</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Normal/Day (NL)</td>
      <td>${todDay}</td>
      <td>${EtodDay}</td>
    </tr>
    <tr>
      <td>Off Peak (OP)</td>
      <td>${todOffpeak}</td>
      <td>${EtodOffpeak}</td>
    </tr>
    <tr>
      <td>Peak (PK)</td>
      <td>${todPeak}</td>
      <td>${EtodPeak}</td>
    </tr>
  </tbody>
</table>

            `
        }
      `
      : ``
  }

  <!-- ===== Summary of I/E/OC/B ===== -->
  <br>
  Units Imported (I): <strong>${importUnits}</strong><span style="font-size: smaller; color: green;"> (As a Prosumer) </span><br>
  Units Exported (E): <strong>${exportUnits}</strong><span style="font-size: smaller; color: green;"> (As a Prosumer) </span><br><br>
  Total Solar Energy Generated (GM): <strong>${isNaN(Solar) ? "NA" : Solar} units</strong><br>
  Own solar consumption during Day [OC]: <strong>${ownSolarDay} units</strong><br><br>
  Net units Imported [N] (N = I - E): <strong>${netImpUnits} units</strong><br>
  Previous banked balance [B]: <strong>${Bank} units</strong><br>

  <!-- ===== Prosumer Section ===== -->
  <div class="pdf-page-break"></div>
  <h3 style="color: blue;">Prosumer Bill</h3><br>
  Billing Type: <strong>${connectionType}, ${importUnits >= 250 ? 'TOD' : 'Non-TOD'}</strong><br><br>

  Own solar consumption during Day [OC]: <strong>${ownSolarDay} units</strong><br>  
  Previous banked balance [B]: <strong>${Bank} units</strong><br>
  Updated banked balance (UB): <strong>${newBank} units</strong> <br> 

  <br>
  Units Billed (N-B): <strong>${netUnits}</strong> 
  <span style="font-size: smaller; color: red;">(${netImpUnits} - ${Bank} => ${netUnits})</span><br>
  
  
<!-- Adjusted TOD units (Prosumer, TOD avaliable and non-telescopic only) -->
${ TODAvailability === "yes"
    ? renderProsumerTODBreakdown(billmethPros, netUnits, actualImport, netImport, adjImport)
    : ""
}
<br>



  <!-- Energy Charge (Prosumer) -->
  Energy Charge:
  <strong>‚Çπ ${energyCharge.toFixed(2)}</strong><br>
  <span style="font-size: smaller; color: red;">${EChargeString}</span><br>
  ${ renderProsumerBillingBlock(billmethPros, netUnits, ProsESlab, slabEPros, todRates) }
  <br>

  <!-- Fixed, Duty, Fuel and Meter Charges -->
  <div class="avoid-page-break">
    Fixed Charge: <strong>‚Çπ ${fixedCharge.toFixed(2)}</strong>
    <span style="font-size: smaller; color: green;">(${fixedChargeStr}: ${fixedLabel} slab, ${phaseType} phase)</span><br>

    Duty (${duty}% of Energy): <strong>‚Çπ ${dutyAmount.toFixed(2)}</strong>
    <span style="font-size: smaller; color: red;">(${energyCharge.toFixed(2)} √ó ${duty}% = ${dutyAmount.toFixed(2)})</span><br>

    Fuel Surcharge (${surcharge}/unit):
    <strong>‚Çπ ${surchargeAmount.toFixed(2)}</strong>
    <span style="font-size: smaller; color: red;">(${netUnits} √ó ${surcharge} = ${surchargeAmount.toFixed(2)})</span><br><br>
  </div>

  Meter Rent: <strong>‚Çπ ${meterCharge.toFixed(2)}</strong> 
  <span style="font-size: smaller; color: green;">(Optional: ${phaseType} phase net meter rent)</span>
  <br><br>
  <b>Total Bill (prosumer): ‚Çπ ${total.toFixed(2)}</b><br>
 

  <!-- ===== Consumer Section ===== -->
  <div class="pdf-page-break"></div>
  <div class="avoid-page-break">
    <h3 style="color: blue;">Predicted Bill: If You Were a Consumer </h3><br>
    Billing Type: <strong>${connectionType}, ${consumerImport >= 250 ? 'TOD' : 'Non-TOD'}</strong><br><br>

    Billed Units [I + OC]: ${importUnits} + ${ownSolarDay} = <strong>${consumerImport}</strong><br>

    <!-- Adjusted TOD units (Consumer, non-telescopic) -->
    ${billmethCons === "non-telescopic"
      ? `
         Adj_NL Reading [NL + OC]: ${dayTotal}<br>
         Adjusted TOD Units: Adj_NL: <strong>${dayTotal}</strong>,
         OP: <strong>${todOffpeak}</strong>,
         PK: <strong>${todPeak}</strong><br>
       `
      : ``}
    <br>

    <!-- Energy Charge (Consumer) -->
    Energy Charge:
    <strong>${userChoice === "skipped" ? 'NA' : consumerEnergy.toFixed(2)}</strong><br>
    <span style="font-size: smaller; color: red;">
      ${userChoice === "skipped" ? 'TOD readings to be provided' : consumerEString}
    </span><br>

    <span style=color: green;">
     ${ renderConsumerBillingBlock(billmethCons, consumerImport, ConsESlab, slabECons, todRates) }     
    </span>
    <br><br>

    <!-- Fixed, Duty, Fuel and Meter Charges (Consumer) -->
    Fixed Charge: <strong>‚Çπ ${consumerFixed.toFixed(2)}</strong>
    <span style="font-size: smaller; color: green;">(${fixedChargeStr}: ${fixedLabel} slab, ${phaseType} phase)</span><br>

    Duty (${duty}% of Energy): <strong>‚Çπ ${consumerdutyAmount.toFixed(2)}</strong>
    <span style="font-size: smaller; color: red;">(${consumerEnergy.toFixed(2)} √ó ${duty}% = ${consumerdutyAmount.toFixed(2)})</span><br>

    Fuel Surcharge (${surcharge}/unit): <strong>‚Çπ ${consumersurchargeAmount.toFixed(2)}</strong>
    <span style="font-size: smaller; color: red;">(${consumerImport} √ó ${surcharge} = ${consumersurchargeAmount.toFixed(2)})</span><br><br>

    Meter Rent: <strong>‚Çπ ${consumerMeter.toFixed(2)}</strong>
    <span style="font-size: smaller; color: green;">(Optional: ${phaseType} phase net meter rent)</span>
  <br><br>
    <b>Total Bill (consumer): ‚Çπ ${userChoice === "skipped" ? 'NA' : consumerTotal.toFixed(2)}</b>
  </div>

</div>
`
  resultDiv.scrollIntoView({behavior: 'smooth'}); 
    // Optional: Enable debug panel if needed
    // showDebugPanel();
});

});
 

</script>

</body>

</html>


  





