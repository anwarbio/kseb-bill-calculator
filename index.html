<!DOCTYPE html>
<html lang="ml">
<head>
  <meta charset="UTF-8">
  <title>KSEB Prosumer Bill Calculator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Malayalam font -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Malayalam&display=swap" rel="stylesheet">
  <!-- PDF download support -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    /* === Base Styling === */
    body {
      font-family: 'Noto Sans Malayalam', Arial, sans-serif;
      margin: 1rem;
      background: #f7f7f7;
    }

    h1 {
      color: #1e88e5;
      font-size: 1.5rem;
    }

  .result h3 {
  margin-bottom: 0.5rem; /* Reduce bottom space */
  margin-top: 1rem;      /* Optional: reduce top space too */
}

    input, select, button {
      padding: 0.6rem;
      margin: 0.5rem 0;
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
    }

    /* === Results Box === */
    .result {
      background: #e3f2fd;
      padding: 1rem;
      margin-top: 1rem;
      border-left: 5px solid #1e88e5;
      word-wrap: break-word;
    }

    /* === Timestamps and Update Info === */
    .timestamp {
      font-size: 0.9rem;
      color: #555;
      margin-bottom: 1rem;
    }

    /* === Debug panel === */
    .debug {
      background: #fff8dc;
      color: #333;
      font-family: monospace;
      white-space: pre-wrap;
      border: 1px dashed #aaa;
      padding: 1rem;
      margin-top: 1rem;
    }

    .hidden {
      display: none;
    }

    /* === PDF download button === */
    #downloadFullPDF {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 0.75rem;
      font-size: 1rem;
      width: 100%;
      margin-top: 1rem;
    }

    
#pdfContent {
  transform: scale(0.94);
  transform-origin: top left;
  width: 125%;
}

.result, .input-section {
  zoom: 0.90; /* scales only result & input content visually */
  transform-origin: top left;
}

.pdf-page-break {
  page-break-before: always;
  margin: 0;
  padding: 0;
  border: none;
  height: 0 !important;
  line-height: 0 !important;
  font-size: 0 !important;
}
  

    /* Responsive heading for wider screens */
    @media (min-width: 600px) {
      h1 {
        font-size: 2rem;
      }
    }

    /* Print-friendly settings */
    @media print {
      body, html, #pdfContent {
      width: 100% !important;
      }
      #billForm, #downloadFullPDF, .timestamp, #debugPanel {
        display: none;
      }
      .result {
        display: block !important;
      }
    }

   
body, html, #pdfContent {
  width: 100% !important;
  max-width: none !important;
  overflow-x: visible !important;
}

input, select, button, label {
  max-width: 100% !important;
  box-sizing: border-box;
}

</style>
</head>

<body>
  
  <div id="pdfContent">
    <h1>KSEB Prosumer Bill Calculator / ‡¥ï‡µÜ.‡¥é‡¥∏‡µç.‡¥á.‡¥¨‡¥ø. ‡¥™‡µç‡¥∞‡µã‡¥∏‡µç‡¥Ø‡µÇ‡¥Æ‡µº ‡¥¨‡¥ø‡µΩ ‡¥ï‡¥æ‡µΩ‡¥ï‡µç‡¥ï‡µÅ‡¥≤‡µá‡¥±‡µç‡¥±‡µº</h1>

    <!-- Top bar: Timestamp (left) and Last Update (right) -->
    <div style="display: flex; justify-content: space-between; font-size: 0.9rem; color: #555; margin-bottom: 1rem;">
      <div id="timestamp"></div>
      <div id="lastUpdatedDisplay"></div>
    </div>

    <!-- === Bill Input Form === -->
    <form id="billForm">

      <label for="connectionType">Connection Type / ‡¥ï‡¥£‡¥ï‡µç‡¥∑‡µª ‡¥§‡¥∞‡¥Ç:</label>
      <select id="connectionType" title="Select your connection type">
      <option value="LT1">LT-1 Domestic / ‡¥°‡µä‡¥Æ‡¥∏‡µç‡¥±‡µç‡¥±‡¥ø‡¥ï‡µç</option>
      </select>

      <label for="Phase Type">Phase Type / ‡¥´‡µá‡¥∏‡µç ‡¥§‡¥∞‡¥Ç:</label>
      <select id="phaseType" title="Select your phase type">
      <option value="single">Single Phase / ‡¥∏‡¥ø‡¥Ç‡¥ó‡¥ø‡µæ ‡¥´‡µá‡¥∏‡µç</option>
      <option value="three">Three Phase / ‡¥§‡µç‡¥∞‡¥ø‡¥´‡µá‡¥∏‡µç</option>
      </select>


      <label for="Bank">Previous Bank Balance Units:</label>
      <input type="number" id="Bank" value="0" placeholder="e.g. 10">

      <label for="TODAvailability">Is TOD Bill Available? / ‡¥ü‡¥ø‡¥í‡¥°‡¥ø ‡¥¨‡¥ø‡µΩ ‡¥≤‡¥≠‡µç‡¥Ø‡¥Æ‡¥æ‡¥£‡µã?</label>
      <select id="TODAvailability" title="Select yes if TOD bill is available">
      <option value="No"> No / ‡¥á‡¥≤‡µç‡¥≤</option>
      <option value="Yes">Yes / ‡¥â‡¥£‡µç‡¥ü‡µç</option>
      </select>


     <div id="importField">      
     <label>Units Imported from Grid [I] / ‡¥ó‡µç‡¥∞‡¥ø‡¥°‡¥ø‡µΩ ‡¥®‡¥ø‡¥®‡µç‡¥®‡µÅ‡¥≥‡µç‡¥≥ ‡¥á‡¥Ç‡¥™‡µã‡µº‡¥ü‡µç‡¥ü‡µç:</label>
      <input type="number" id="importUnits" required placeholder="Units imported from grid.e.g. 100"><br>
     </div>

      <label>Units Exported to Grid [E] / ‡¥ó‡µç‡¥∞‡¥ø‡¥°‡¥ø‡¥≤‡µá‡¥ï‡µç‡¥ï‡µç ‡¥Ö‡¥Ø‡¥ö‡µç‡¥ö ‡¥Ø‡µÇ‡¥£‡¥ø‡¥±‡µç‡¥±‡µÅ‡¥ï‡µæ:</label>
      <input type="number" id="exportUnits" required placeholder="Units exported to grid.e.g. 100"><br>

      <label>Total Solar Energy Generation [GM] / ‡¥Æ‡µä‡¥§‡µç‡¥§‡¥Ç ‡¥∏‡µã‡¥≥‡¥æ‡µº ‡¥ä‡µº‡¥ú ‡¥â‡µΩ‡¥™‡¥æ‡¥¶‡¥®‡¥Ç:</label>
      <input type="number" id="Solar" value="0" placeholder="Units of solar generated e.g. 100"><br>

      <!-- Hidden initially, visible if TOD enabled -->
      <div id="todFields" class="hidden">
        <label>Normal (day) Units (NL) / ‡¥¶‡¥ø‡¥® ‡¥∏‡¥Æ‡¥Ø ‡¥â‡¥™‡¥≠‡µã‡¥ó‡¥Ç:</label>
        <input type="number" id="todDay" placeholder="Units imported during day time (normal: NL).e.g. 100"> <br>

        <label>Off-Peak Units (OP) / ‡¥ì‡¥´‡µç-‡¥™‡µÄ‡¥ï‡µç‡¥ï‡µç ‡¥â‡¥™‡¥≠‡µã‡¥ó‡¥Ç:</label>
        <input type="number" id="todOffpeak" placeholder="Units imported during off peak time (off peak: OP).e.g. 100"><br>

        <label>Peak Units (PK) / ‡¥™‡µÄ‡¥ï‡µç‡¥ï‡µç ‡¥ü‡µà‡¥Ç ‡¥â‡¥™‡¥≠‡µã‡¥ó‡¥Ç:</label>
        <input type="number" id="todPeak" placeholder="Units imported during peak time (peak: PK).e.g. 100"><br>
      </div>

      <button type="submit">Calculate / ‡¥ï‡¥æ‡µΩ‡¥ï‡µç‡¥ï‡µÅ‡¥≤‡µá‡¥±‡µç‡¥±‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥ï</button>

      <!-- Hidden field for tracking last update -->
      <input type="hidden" id="lastUpdated" value=" 07 Aug 2025">
    </form>

    <!-- === Output Section === -->
  <div class="pdf-page-break"></div>
  <div class="result" id="result" style="display: none;"></div>
    
  <div id="debugPanel" class="debug hidden"></div>
  </div>

  <!-- PDF Download Button -->
  <button id="downloadFullPDF">Download Full Page as PDF</button>

<!--Custom Alters -->
  <div id="customAlert" style="display:none; position:fixed; top:30%; left:50%; transform:translate(-50%,-50%);
     background:#fff; border:2px solid red; padding:20px; z-index:1000; box-shadow:0 0 10px #000; color:red;">
  <h3 style="margin-top:0;">Alert!</h3>
  <div id="customAlertMessage"></div>
  <button onclick="document.getElementById('customAlert').style.display='none'">Close</button>
</div>

<script>
  // Set current date and time
  const now = new Date();
  document.getElementById('timestamp').textContent =
    `Date: ${now.toLocaleDateString()} | Time: ${now.toLocaleTimeString()}`;

  // Set last updated info
  const lastUpdatedValue = document.getElementById('lastUpdated').value;
  document.getElementById('lastUpdatedDisplay').textContent =
    `Software Last Updated: ${lastUpdatedValue}`;
  </script>

<script>
  // to display custom Alerts
function showCustomAlert(message) {
  document.getElementById("customAlertMessage").innerHTML = message;
  document.getElementById("customAlert").style.display = "block";
}
</script>

<script>
 document.addEventListener('DOMContentLoaded', function () {
  const todDropdown = document.getElementById('TODAvailability');
  const todSection = document.getElementById('todFields');
  const importField = document.getElementById('importField');
  const importUnitsInput = document.getElementById('importUnits');

  function handleTODToggle() {
    if (todDropdown.value === 'Yes') {
      todSection.classList.remove('hidden');
      importField.classList.add('hidden');
      importUnitsInput.removeAttribute('required');
    } else {
      todSection.classList.add('hidden');
      importField.classList.remove('hidden');
      importUnitsInput.setAttribute('required', '');
    }
  }

  todDropdown.addEventListener('change', handleTODToggle);
  handleTODToggle(); // Run on page load
});
</script>


<script>
  // Handle PDF download
  document.getElementById('downloadFullPDF').addEventListener('click', () => {
    const element = document.getElementById('pdfContent');
const opt = {
  margin:       0.3, // in inches
  filename:     `KSEB_Bill_${new Date().toISOString().split('T')[0]}.pdf`,
  image:        { type: 'jpeg', quality: 0.98},
  html2canvas: {
    scale: 4,         // High DPI rendering
    scrollY: 0,
    useCORS: true,      // In case fonts or images are external
    windowWidth: element.scrollWidth, // Force full width
    windowHeight: element.scrollHeight
  },
  jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' },
  pagebreak: { mode: ['css', 'legacy'] }
};
html2pdf().set(opt).from(element).save();
});
</script>

<script> 
// -----------------------------------------
// Billing & Tariff Calculation Logic
// -----------------------------------------

// CSV Data Arrays
let slabs = [], chargesTable = [], todRates = {};
let fixedChargeTable = [], meterChargeTable = [];
let isTOD = false, todBaseRate = 0, totalImport = 0;

// Debug Logging Array
let debugLog = [];

// Show Debug Log Panel
function showDebugPanel() {
  const panel = document.getElementById('debugPanel');
  panel.classList.remove('hidden');
  panel.textContent = debugLog.join('\n');
}

// CSV Loading and Parsing
function loadCSV(file, parser) {
  return fetch(file)
    .then(res => res.ok ? res.text() : Promise.reject(`Failed to load ${file}`))
    .then(text => {
      parser(text);
      debugLog.push(`[LOADED] ${file}`);
    })
    .catch(error => {
      console.error(`[CSV ERROR] ${file}:`, error);
      debugLog.push(`[ERROR] ${error}`);
    });
}

function parseSlabs(text) {
  const lines = text.trim().split('\n').slice(1);
  slabs = lines.map(line => {
    const [range, rate] = line.split(',');
    const upper = parseInt(range.split('-')[1] || range.match(/\d+/g)?.[0]) || 0;
    return { limit: upper, rate: parseFloat(rate) };
  });
  debugLog.push(`Parsed Slabs: ${JSON.stringify(slabs)}`);
}

function parseTODRates(text) {
  const lines = text.trim().split('\n').slice(1);
  todRates = {};
  lines.forEach(line => {
    const [label, rate] = line.split(',');
    todRates[label.trim().toLowerCase()] = parseFloat(rate);
  });
  debugLog.push(`TOD Rates: ${JSON.stringify(todRates)}`);
}

function parseTODTariff(text) {
  const lines = text.trim().split('\n').slice(1);
  for (let line of lines) {
    const [range, base] = line.split(',');
    const upper = /above/i.test(range) ? Infinity : parseInt(range.match(/\d+/g)?.[0]) || 0;
    if (totalImport <= upper) {
      todBaseRate = parseFloat(base);
      break;
    }
  }
  debugLog.push(`TOD Base Rate: ${todBaseRate}`);
}

function parseCharges(text) {
  const lines = text.trim().split('\n').slice(1);
  chargesTable = lines.map(line => {
    const [label, duty, surcharge] = line.split(',');
    return {
      label: label.trim(),
      duty: parseFloat(duty),
      surcharge: parseFloat(surcharge)
    };
  });
  debugLog.push(`Other Charges: ${JSON.stringify(chargesTable)}`);
}

function parseFixedCharges(text) {
  const lines = text.trim().split('\n').slice(1);
  fixedChargeTable = lines.map(line => {
    const [slab, single, three] = line.split(',');
    let min = 0, max = Infinity;
    if (slab.includes('-')) {
      [min, max] = slab.split('-').map(Number);
    } else if (/above/i.test(slab)) {
      min = parseInt(slab.match(/\d+/)?.[0]) || 0;
    }
    return { min, max, label: slab.trim(), single: parseFloat(single), three: parseFloat(three) };
  });
  debugLog.push(`Fixed Charges: ${JSON.stringify(fixedChargeTable)}`);
}

function parseMeterCharges(text) {
  const lines = text.trim().split('\n').slice(1);
  meterChargeTable = lines.map(line => {
    const [type, single, three] = line.split(',');
    return {
      label: type.trim(),
      single: parseFloat(single),
      three: parseFloat(three)
    };
  });
  debugLog.push(`Meter Charges: ${JSON.stringify(meterChargeTable)}`);
}

// -----------------------------------
// Utility Functions for Bill Charges
// -----------------------------------

function getFixedCharge(phaseType, totalUnits) {
  for (let row of fixedChargeTable) {
    if (totalUnits > row.min && totalUnits <= row.max) {
      return {
        value: phaseType === 'three' ? row.three : row.single,
        label: row.label
      };
    }
  }
  return { value: 0, label: 'Not found' };
}

function getMeterRent(connectionType, phaseType) {
  for (let row of meterChargeTable) {
    if (row.label === connectionType) {
      const value = phaseType === 'three' ? row.three : row.single;
      const label = `${row.label}-${phaseType}`;
      return { value, label };
    }
  }
  return { value: 0, label: 'Not found' };
}

function getOtherCharges(connectionType) {
  for (let row of chargesTable) {
    if (row.label === connectionType) {
      return {
        duty: row.duty,
        surcharge: row.surcharge
      };
    }
  }
  return { duty: 0, surcharge: 0 };
}

function getBillingTypeProsumer(importUnits, exportUnits, Solar, Bank) {
  const ownSolarDay = Solar - exportUnits;
  const totalUnits = importUnits + ownSolarDay;
  const netUnits = importUnits - exportUnits;
  const bankReduced = netUnits - Bank;

  let billtype = "telescopic"; // Default assumption for low usage

  if (importUnits >= 250 && bankReduced < 250) {
    billtype = "non-telescopic";
  } else if (importUnits >= 250 && bankReduced >= 250) {
    billtype = "telescopic";
  }

  return { billtype };
}

function getBillingTypeConsumer(importUnits, exportUnits, Solar, Bank) {
  const ownSolarDay = Solar - exportUnits;
  const totalUnits = importUnits + ownSolarDay;

  let billtype = "telescopic"; // Default assumption

  if (totalUnits >= 250) {
    billtype = "non-telescopic";
  }

  return { billtype };
}

// -----------------------------
// Energy Charge Calculations
// -----------------------------

function calculateDomesticCharge(units) {
  let total = 0, prevLimit = 0;
  for (let i = 0; i < slabs.length && units > 0; i++) {
    const slab = slabs[i];
    const slabUnits = Math.min(units, slab.limit - prevLimit);
    const charge = slabUnits * slab.rate;
    console.log(`Slab ${i}: ${slabUnits} units * ‚Çπ${slab.rate} = ‚Çπ${charge}`);
    total += charge;
    units -= slabUnits;
    prevLimit = slab.limit;
  }
  console.log("Total energyCharge:", total);
  return total;
}


function calculateDomesticChargeString(units) {
  let total = 0, prevLimit = 0;
  const parts = [];
  for (let i = 0; i < slabs.length && units > 0; i++) {
    const slab = slabs[i];
    const slabUnits = Math.min(units, slab.limit - prevLimit);
    const charge = slabUnits * slab.rate;
    parts.push(`${slabUnits} units * ‚Çπ${slab.rate.toFixed(2)} = ‚Çπ${charge.toFixed(2)}`);
    total += charge;
    units -= slabUnits;
    prevLimit = slab.limit;
  }
  return parts.length > 0 ? parts.join(' + ') : '0 units billed';
}

function calculateTODCharge(day, peak, offpeak) {
  return todBaseRate * (
    (day * todRates.nl) +
    (peak * todRates.pk) +
    (offpeak * todRates.op)
  );
}

function getTODCalculationString(day, peak, offpeak) {
  const parts = [];
  if (day > 0) parts.push(`NL:${day} * ‚Çπ${todBaseRate} * ${todRates.nl} = ‚Çπ${(day * todBaseRate * todRates.nl).toFixed(2)}`);
  if (offpeak > 0) parts.push(`OP:${offpeak} * ‚Çπ${todBaseRate} * ${todRates.op} = ‚Çπ${(offpeak * todBaseRate * todRates.op).toFixed(2)}`);
  if (peak > 0) parts.push(`PK:${peak} * ‚Çπ${todBaseRate} * ${todRates.pk} = ‚Çπ${(peak * todBaseRate * todRates.pk).toFixed(2)}`);
  return parts.length > 0 ? parts.join(' <span style="font-weight:bold; font-size:1.5em;"> + </span> ') : '0 units billed';
}

function getFixedChargeString(importUnits, ownSolarDay) {
  const total = importUnits + ownSolarDay;
  return `I:${importUnits}+OC:${ownSolarDay}=${total}`;
}


function getEnergy(todDay, todOffpeak, todPeak, importUnits, exportUnits, Bank) {
  
  let remainingExport = exportUnits + Bank;

  let adjDay = todDay;
  let adjOffpeak = todOffpeak;
  let adjPeak = todPeak;

  // Step 1: Subtract from Import Surplus (in order: Day ‚Üí Offpeak ‚Üí Peak)
  if (remainingExport  > 0) {
    const useFromImport = Math.min(adjDay, remainingExport );
    adjDay -= useFromImport;
    remainingExport  -= useFromImport;
  }

  if (remainingExport  > 0) {
    const useFromImport = Math.min(adjOffpeak, remainingExport );
    adjOffpeak -= useFromImport;  // ‚úÖ fixed here
    remainingExport  -= useFromImport;
  }

  if (remainingExport  > 0) {
    const useFromImport = Math.min(adjPeak, remainingExport );
    adjPeak -= useFromImport;
    remainingExport  -= useFromImport;
  }
  // Final calculation
  const energyCharge = calculateTODCharge(adjDay, adjPeak, adjOffpeak);
  const EChargeString = getTODCalculationString(adjDay, adjPeak, adjOffpeak);


console.log("adjDay:", adjDay);
console.log("adjOffpeak:", adjOffpeak);
console.log("adjPeak:", adjPeak);
console.log("energyCharge:", energyCharge);
console.log("todBaseRate:", todBaseRate);
console.log("todRates:", todRates);

  return {
    energyCharge,
    EChargeString,
    adjDay,
    adjOffpeak,
    adjPeak
  };
}



async function setupBilling(importUnits) {  

  await Promise.all([
  loadCSV('fixed_charge.csv', parseFixedCharges),
  loadCSV('meter_charges.csv', parseMeterCharges),
  loadCSV('other_charges.csv', parseCharges),
  loadCSV('tariff_tod_base.csv', parseTODTariff),
  loadCSV('tariff_tod.csv', parseTODRates),
  loadCSV('tariff_domestic_telescopic.csv', parseSlabs)]);

  if (importUnits >= 250) {
    document.getElementById('todFields').classList.remove('hidden');
    
  } else {
    document.getElementById('todFields').classList.add('hidden');    
  }
}
</script>

<script>

function showYesNoPrompt(message) {
  return new Promise((resolve) => {
    const modal = document.createElement("div");
    modal.id = "customPrompt";
    modal.style.position = "fixed";
    modal.style.top = "0";
    modal.style.left = "0";
    modal.style.width = "100%";
    modal.style.height = "100%";
    modal.style.backgroundColor = "rgba(0,0,0,0.5)";
    modal.style.display = "flex";
    modal.style.justifyContent = "center";
    modal.style.alignItems = "center";
    modal.style.zIndex = "9999";

    modal.innerHTML = `
      <div style="background:white; padding:20px; border-radius:8px; max-width:500px; text-align:center">
        <div style="margin-bottom:20px;">${message}</div>
        <button id="yesBtn" style="margin-right:20px; padding:6px 14px;">Yes</button>
        <button id="noBtn" style="padding:6px 14px;">No</button>
      </div>
    `;

    document.body.appendChild(modal);

    document.getElementById("yesBtn").onclick = () => {
      document.body.removeChild(modal);
      resolve(true);
    };

    document.getElementById("noBtn").onclick = () => {
      document.body.removeChild(modal);
      resolve(false);
    };
  });
}

let userChoice = "";

</script>



<script>

// Form submit event: Main calculation handler
document.getElementById('billForm').addEventListener('submit', async function (e) {
  e.preventDefault();

  const connectionType = document.getElementById('connectionType').value;
  const phaseType = document.getElementById('phaseType').value;
  const exportUnits = parseFloat(document.getElementById('exportUnits').value) || 0;
  const importUnitsInput = parseFloat(document.getElementById('importUnits').value) || 0;
  const Solar = parseFloat(document.getElementById('Solar').value) || 0;
  const Bank = parseFloat(document.getElementById('Bank').value) || 0;
  const TODAvailability = document.getElementById('TODAvailability').value.trim().toLowerCase();
  
  const todDay = parseFloat(document.getElementById('todDay').value) || 0;
  const todOffpeak = parseFloat(document.getElementById('todOffpeak').value) || 0;
  const todPeak = parseFloat(document.getElementById('todPeak').value) || 0;

  let importUnits;
  if (TODAvailability === "yes") {
    importUnits = todDay + todOffpeak + todPeak;
  } else {
    importUnits = importUnitsInput;
  }

  if (isNaN(importUnits)) {
    alert("Please enter a valid import unit value.");
    return;
  }  

  await setupBilling(importUnits);

  const ownSolarDay = Solar - exportUnits;
  const totalUnits = importUnits + ownSolarDay;
  const consumerImport = totalUnits;
  const netImpUnits = Math.max(0, importUnits - exportUnits);
  const netUnits = Math.max(0, importUnits - (Bank + exportUnits));
  const newBank = Math.max(0, Bank + exportUnits - importUnits);

  const billmethPros = getBillingTypeProsumer(netUnits, exportUnits, Solar, Bank).billtype;

  const meterInfo = getMeterRent(connectionType, phaseType);
  const fixedInfo = getFixedCharge(phaseType, totalUnits);
  const fixedChargeStr = getFixedChargeString(importUnits, ownSolarDay);
  const { value: meterCharge } = meterInfo;
  const { value: fixedCharge, label: fixedLabel } = fixedInfo;
  const { duty, surcharge } = getOtherCharges(connectionType);

  let energyCharge = 0, EChargeString = "";
  let adjDay = 0, adjOffpeak = 0, adjPeak = 0;
  let todP = 0, dayTotal = 0;

console.log("testing if the fxn is called");

  if (netUnits >= 250) {
    console.log("Calling getEnergy...");
  const energyResult = getEnergy(todDay, todOffpeak, todPeak, importUnits, exportUnits, Bank);
  energyCharge = energyResult.energyCharge;
  EChargeString = energyResult.EChargeString;
  adjDay = energyResult.adjDay;
  adjOffpeak = energyResult.adjOffpeak;
  adjPeak = energyResult.adjPeak;
  console.log("Returned from getEnergy");

} else {
  console.log("Calling getEnergy Domestic...");
  console.log("slabs:", slabs);
  energyCharge = calculateDomesticCharge(netUnits);
  EChargeString = calculateDomesticChargeString(netUnits);
  console.log("Returned getEnergy Domestic...");
}
  
    
  const dutyAmount = energyCharge * duty / 100;
  const surchargeAmount = surcharge * netUnits;
  const total = energyCharge + fixedCharge + meterCharge + dutyAmount + surchargeAmount;

  await setupBilling(consumerImport);

 

  let consumerEnergy = 0, consumerFixed = 0, consumerMeter = 0;
  let consumerMsg = ""; let consumerEString = "";

  const consumerMeterInfo = getMeterRent(connectionType, phaseType);
  const consumerFixedInfo = getFixedCharge(phaseType, consumerImport);
  consumerMeter = consumerMeterInfo.value;
  consumerFixed = consumerFixedInfo.value;

 console.log("ConsumerImport:", consumerImport);


 
if (TODAvailability === "no" && consumerImport >= 250 && userChoice == "" ) {  
    const message = `
    To estimate consumer bill, you need to input TOD readings.<br><br>
    üìå Do you want to skip estimating bill as a Consumer? <br>
    ‡¥®‡¥ø‡¥ô‡µç‡¥ô‡µæ ‡¥â‡¥™‡¥≠‡µã‡¥ï‡µç‡¥§‡µÉ ‡¥¨‡¥ø‡µΩ ‡¥ï‡¥£‡¥ï‡µç‡¥ï‡¥æ‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥®‡¥§‡µç ‡¥í‡¥¥‡¥ø‡¥µ‡¥æ‡¥ï‡µç‡¥ï‡¥£‡µã?
  `;
  const proceed = await showYesNoPrompt(message);

  if (proceed) {
    Consumerbill = "No"; // User chose to skip
    userChoice = "skipped";
  } else {
    Consumerbill = "Yes";
    userChoice = "need";      
  }
  console.log("userChoice:", userChoice);
  console.log("Consumerbill:", Consumerbill);
}


  if (userChoice == "need" && TODAvailability === "no" && consumerImport >= 250) {  

     if (todDay === 0 && todPeak === 0 && todOffpeak === 0) {
    const message = `
    To calculate as a <b>Consumer (non-Prosumer)</b>, please provide TOD readings for total units: <b>${consumerImport}</b> (including Own Consumption from Solar [OC]).
    <br><br>üîÜ Own consumption from solar from the given input is <b>${ownSolarDay}</b> units.
    <br><br>‡¥â‡¥™‡¥≠‡µã‡¥ï‡µç‡¥§‡¥æ‡¥µ‡¥æ‡¥Ø‡¥ø ‡¥ï‡¥£‡¥ï‡µç‡¥ï‡¥æ‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥®‡¥§‡¥ø‡¥®‡µç ‡¥â‡¥™‡¥Ø‡µã‡¥ó‡¥ø‡¥ö‡µç‡¥ö ‡¥Æ‡µä‡¥§‡µç‡¥§‡¥Ç ‡¥Ø‡µÇ‡¥£‡¥ø‡¥±‡µç‡¥±‡µÅ‡¥ï‡µæ (I + OC) [${consumerImport} ‡¥Ø‡µÇ‡¥£‡¥ø‡¥±‡µç‡¥±‡µÅ‡¥ï‡µæ] ‡¥ü‡¥ø‡¥Ø‡µã‡¥ü‡¥ø (TOD) ‡¥±‡µÄ‡¥°‡¥ø‡¥ô‡µç ‡¥Æ‡¥æ‡¥§‡µÉ‡¥ï‡¥Ø‡¥ø‡µΩ ‡¥®‡µΩ‡¥ï‡µá‡¥£‡µç‡¥ü‡¥§‡¥æ‡¥£‡µç (‡¥∏‡µç‡¥µ‡¥Ø‡¥Ç ‡¥â‡¥™‡¥Ø‡µã‡¥ó‡¥ø‡¥ö‡µç‡¥ö ‡¥∏‡µã‡¥≥‡¥æ‡µº ‡¥Ø‡µÇ‡¥£‡¥ø‡¥±‡µç‡¥±‡µÅ‡¥ï‡µæ [OC] ‡¥â‡µæ‡¥™‡µç‡¥™‡µÜ‡¥ü‡µÜ).
    <br><br>üìå ‡¥®‡µΩ‡¥ï‡¥ø‡¥Ø‡¥ø‡¥∞‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥® ‡¥±‡µÄ‡¥°‡¥ø‡¥ô‡µç ‡¥Ö‡¥®‡µÅ‡¥∏‡¥∞‡¥ø‡¥ö‡µç‡¥ö‡µÅ ‡¥∏‡µç‡¥µ‡¥Ø‡¥Ç ‡¥â‡¥™‡¥Ø‡µã‡¥ó‡¥ø‡¥ö‡µç‡¥ö ‡¥∏‡µã‡¥≥‡¥æ‡µº ‡¥Ø‡µÇ‡¥£‡¥ø‡¥±‡µç‡¥±‡µÅ‡¥ï‡µæ <b>(${ownSolarDay} ‡¥Ø‡µÇ‡¥£‡¥ø‡¥±‡µç‡¥±‡µç‡¥∏‡µç)</b> ‡¥Ü‡¥£‡µç.
  `;
  showCustomAlert(message);
  return; }

                
    const sumImport = todDay + todPeak + todOffpeak;

    
    
    if (userChoice == "need" && todDay < ownSolarDay) {
      alert(`As a Consumer, Daytime TOD units (NL) must be ‚â• Own Solar Use (GM - E) = ${ownSolarDay} units.`);
      return;
    }
    if (userChoice == "need" && sumImport !== totalUnits) {
      alert(`Mismatch: Total TOD units (${sumImport}) ‚â† Total import units (${totalUnits}).`);
      return;      
    }

    if (userChoice == "skipped") {

   todDay = 0;
   todPeak = 0;
   todOffpeak = 0;
   importUnits =0;
   exportUnits = 0;
   Solar = 0;
   Bank = 0;
   ownSolarDay = 0;
    }
    
    dayTotal = todDay;

  } else if (userChoice == "need" && TODAvailability === "yes" && consumerImport >= 250) {
    const sumTOD = todDay + todPeak + todOffpeak;
    dayTotal = todDay + ownSolarDay;
    }  

  const billmethCons = getBillingTypeConsumer(importUnits, exportUnits, Solar, Bank).billtype;

 if (billmethCons === "telescopic") {
    consumerEnergy = calculateDomesticCharge(consumerImport);
    consumerEString = calculateDomesticChargeString(consumerImport);}

  if (billmethCons === "non-telescopic") {
    console.log("Consumer non-telescopic energy charge gets called");
    consumerEnergy = calculateTODCharge(dayTotal, todPeak, todOffpeak);
    consumerEString = getTODCalculationString(dayTotal, todPeak, todOffpeak);
  
  console.log("Consumer tod NL:", dayTotal);
  console.log("Consumer tod PK:", todPeak);
  console.log("Consumer tod PK:", todOffpeak);
    
  }
 
 
  const consumerdutyAmount = consumerEnergy * duty / 100;
  const consumersurchargeAmount = surcharge * consumerImport;
  const consumerTotal = consumerEnergy + consumerFixed + consumerMeter + consumerdutyAmount + consumersurchargeAmount;

  

  const resultDiv = document.getElementById('result');
  resultDiv.style.display = 'block';
   resultDiv.innerHTML = `
    <h3>Input Values</h3>
    Conection Type: ${connectionType}, Phase Type: ${phaseType}<br>
    <br>
    Given TOD Readings: <br>
    
  ${billmethPros === "telescopic" && TODAvailability == "No"
  ? `Normal/day_time Units:&nbsp; &nbsp; As Prosumer (NL): NA &nbsp;&nbsp; As Consumer (NL + OC): ${todDay}<br>
     Off Peak Units (OP):&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; As Prosumer: NA &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp; As Consumer: ${todOffpeak}<br>
     Peak Units (PK):&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; As Prosumer: NA &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; As Consumer: ${todPeak}<br> `

  : `Normal/day_time Units [NL]: ${todDay} <br>
     Off Peak Units (OP): ${todOffpeak} <br>
     Peak Units (PK): ${todPeak} <br>  
  `}  
  <br>

    Units Imported (I): ${importUnits}<br>
    Units Exported (E): ${exportUnits}<br>
    Total Solar Energy Generated (GM): ${isNaN(Solar) ? "NA" : Solar} units <br>
    Own solar consumption during Day [OC]: ${ownSolarDay} units<br>
    <br>
    Net units Imported [N] (N = I - E): ${netImpUnits} units <br>
    <br>
    Previous banked balance [B]: ${Bank} units <br>
    Updated banked balance [UB] (UB = E + B - I): ${newBank} units <br>
    <br>
    <hr>

    <h3>Prosumer Bill</h3>
    Billing Type: ${connectionType}, ${importUnits >= 250 ? 'TOD' : 'Non-TOD'}, ${billmethPros} <br>
    Own solar consumption during Day [OC]: ${ownSolarDay} units<br>
    Units Billed (N-B): ${netUnits}<br>
    ${billmethPros == "non-telescopic" ? `Adjusted TOD Units: NL: ${adjDay}, OP: ${adjOffpeak}, PK: ${adjPeak}<br>` : ``}
    <br>
    Energy Charge: ‚Çπ ${energyCharge.toFixed(2)}<br>
    <span style="font-size: smaller; color: gray;">(${EChargeString})</span><br>
    <br>
    Fixed Charge: ‚Çπ ${fixedCharge.toFixed(2)} <br>
    <span style="font-size: smaller;">(${fixedChargeStr}, ${fixedLabel} slab)</span><br>
    <br>
    Meter Rent: ‚Çπ ${meterCharge.toFixed(2)}<br>
    Duty (${duty}% of Energy): ‚Çπ ${dutyAmount.toFixed(2)}<br>
    Fuel Surcharge (${surcharge}/unit): ‚Çπ ${surchargeAmount.toFixed(2)}<br>
    <br>
    <b>Total Bill (prosumer): ‚Çπ ${total.toFixed(2)}</b>
    <hr>

    <h3>As a Consumer (Without Export)</h3>
    Billing Type: ${connectionType}, ${consumerImport >= 250 ? 'TOD' : 'Non-TOD'}, ${billmethCons} <br><br>
    Billed Units [I + OC]: ${importUnits} + ${ownSolarDay} = ${consumerImport}<br>
    
    ${billmethCons == "non-telescopic" ? `Adj_NL Reading [NL + OC]: ${dayTotal} <br>
    Adjusted TOD Units: Adj_NL: ${dayTotal}, OP: ${todOffpeak}, PK: ${todPeak}<br>` : ``}
    <br>             
    Energy Charge: ‚Çπ ${consumerEnergy.toFixed(2)}<br>
    <span style="font-size: smaller; color: gray;">(${consumerEString})</span><br>
    <br>
    Fixed Charge: ‚Çπ ${consumerFixed.toFixed(2)} <br>
    <span style="font-size: smaller;">(${fixedChargeStr}, ${fixedLabel} slab)</span><br>
    <br>
    Meter Rent: ‚Çπ ${consumerMeter.toFixed(2)}<br>
    Duty (${duty}% of Energy): ‚Çπ ${consumerdutyAmount.toFixed(2)}<br>
    Fuel Surcharge (${surcharge}/unit): ‚Çπ ${consumersurchargeAmount.toFixed(2)}<br>
    <br>
    <b>Total Bill (consumer): ‚Çπ ${consumerTotal.toFixed(2)}</b>
     `
  resultDiv.scrollIntoView({behavior: 'smooth'}); 
  // Show debug panel if needed
  // showDebugPanel();
});

  
</script>
</body>
</html>

